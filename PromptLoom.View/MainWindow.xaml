<!-- CHANGE LOG
- 2026-03-02 | Request: Feature version bump | Update window title to 2.2.0.
- 2026-03-02 | Request: File relevance pills | Add relevance percent to found/selected file pills.
- 2026-03-02 | Request: File pill labels | Show path portion after Categories with wrapping.
- 2026-03-02 | Request: Selected file pills | Use pill buttons with move/remove controls.
- 2026-03-02 | Request: Search file selection | Add selectable file pills with ordered selection list.
- 2026-03-02 | Fix: Resolve SearchState binding | Point viewModels namespace at PromptLoom.ViewModel assembly.
- 2026-03-02 | Request: Deduplicate prompt panel | Reuse shared prompt UI control for both layouts.
- 2026-01-02 | Request: Related tag relevance | Show related tags with relevance percent.
- 2026-01-02 | Request: Tag counts in UI | Show tag counts and match totals in Search.
- 2026-01-02 | Request: Search refresh icon | Move refresh button to status pane and use icon.
- 2026-01-02 | Request: Tag indexing status | Show indexing status message in Search tab.
- 2026-01-02 | Request: Sync app version | Update window title to 2.1.2.
- 2026-01-02 | Fix: Tag chip commands | Bind add/remove tag buttons to ItemsControl context.
- 2026-01-02 | Fix: Remove duplicate Search tab | Keep a single Search tab per layout.
- 2025-12-31 | Request: Single-image label sizing | Align small-batch labels with thumbnail height.
- 2025-12-31 | Request: SwarmUI cards + toggles | Add model/LoRA cards and send toggles.
-->
<!-- Bugfix: Fix duplicate IconBtn resource key by renaming base style to IconBtnBase so style lookups are unambiguous. -->
<!-- Bugfix: Allow the shared IconBtn style to apply to ToggleButton instances to prevent XamlParseException popups triggered by a Button-only style target. -->
<Window x:Class="PromptLoom.MainWindow"
        PreviewKeyDown="MainWindow_OnPreviewKeyDown"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:conv="clr-namespace:PromptLoom.Converters"
        xmlns:controls="clr-namespace:PromptLoom.Controls"
        xmlns:viewModels="clr-namespace:PromptLoom.ViewModels;assembly=PromptLoom.ViewModel"
        Title="PromptLoom 2.2.0" Height="900" Width="1480"
        Background="{StaticResource BgMain}"
        WindowStartupLocation="CenterScreen">

    <Window.Resources>
        <BooleanToVisibilityConverter x:Key="BoolToVis"/>
        <conv:PastelByIndexConverter x:Key="PastelByIndex"/>
        <conv:AspectToVisibilityConverter x:Key="AspectToVis"/>
        <conv:OneLineTextConverter x:Key="OneLine"/>
        <conv:CategoryPathConverter x:Key="CategoryPathConverter"/>

        <DataTemplate x:Key="SwarmAssetCardTemplate">
            <Border Background="#14000000" BorderBrush="{StaticResource BorderSoft}" BorderThickness="1"
                    CornerRadius="8" Padding="6" Margin="0,2" ToolTip="{Binding Name}">
                <StackPanel>
                    <TextBlock FontWeight="SemiBold" Text="{Binding DisplayName}" TextTrimming="CharacterEllipsis"/>
                    <TextBlock FontSize="11" Opacity="0.65" Text="{Binding PathHint}" TextTrimming="CharacterEllipsis"
                               Visibility="{Binding HasPathHint, Converter={StaticResource BoolToVis}}"/>
                    <TextBlock FontSize="11" Opacity="0.7" Text="{Binding KindLabel}"/>
                </StackPanel>
            </Border>
        </DataTemplate>

        
        <!-- Vector icons (24x24) -->
        <Geometry x:Key="IcoChevronUp">M 12,6 L 6.5,11.5 L 8.0,13.0 L 12,9.0 L 16.0,13.0 L 17.5,11.5 Z</Geometry>
        <Geometry x:Key="IcoChevronDown">M 12,18 L 17.5,12.5 L 16.0,11.0 L 12,15.0 L 8.0,11.0 L 6.5,12.5 Z</Geometry>
        <!-- Used for category ordering buttons embedded in the Advanced View tabs -->
        <Geometry x:Key="IcoChevronLeft">M 9.5,12 L 14.5,7 L 16.0,8.5 L 12.5,12 L 16.0,15.5 L 14.5,17 Z</Geometry>
        <Geometry x:Key="IcoChevronRight">M 14.5,12 L 9.5,7 L 8.0,8.5 L 11.5,12 L 8.0,15.5 L 9.5,17 Z</Geometry>
        <Geometry x:Key="IcoSelectAll">M 6,7 H 18 V 9 H 6 Z M 6,11 H 18 V 13 H 6 Z M 6,15 H 18 V 17 H 6 Z M 4.5,12 L 3.2,10.7 L 2,11.9 L 4.5,14.4 L 8.7,10.2 L 7.5,9 Z</Geometry>
        <Geometry x:Key="IcoSelectNone">M 12,2.5 A 9.5,9.5 0 1 1 11.999,2.5 Z M 7,11 H 17 V 13 H 7 Z</Geometry>
        <Geometry x:Key="IcoRefresh">M17.65,6.35A7.95,7.95 0 0,0 12,4V1L7,6l5,5V7c2.76,0 5,2.24 5,5 0,1.1 -0.36,2.12 -0.97,2.94l1.46,1.46A7.96,7.96 0 0,0 20,12c0-2.21-0.9-4.21-2.35-5.65z M6.35,17.65A7.95,7.95 0 0,0 12,20v3l5-5-5-5v3c-2.76,0-5-2.24-5-5 0-1.1 0.36-2.12 0.97-2.94L6.5,6.61A7.96,7.96 0 0,0 4,12c0,2.21 0.9,4.21 2.35,5.65z</Geometry>

        <!-- Round icon button style -->
        <Style x:Key="IconBtnBase" TargetType="ButtonBase">
            <Setter Property="Width" Value="26"/>
            <Setter Property="Height" Value="26"/>
            <Setter Property="Padding" Value="0"/>
            <Setter Property="Background" Value="#14FFFFFF"/>
            <Setter Property="BorderBrush" Value="#2A000000"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="ToolTipService.ShowDuration" Value="60000"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ButtonBase">
                        <Border x:Name="Bd"
                                Background="{TemplateBinding Background}"
                                BorderBrush="{TemplateBinding BorderBrush}"
                                BorderThickness="{TemplateBinding BorderThickness}"
                                CornerRadius="999"
                                SnapsToDevicePixels="True">
                            <ContentPresenter HorizontalAlignment="Center"
                                              VerticalAlignment="Center"
                                              RecognizesAccessKey="True"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="Bd" Property="Background" Value="#26FFFFFF"/>
                                <Setter TargetName="Bd" Property="BorderBrush" Value="#55000000"/>
                            </Trigger>
                            <Trigger Property="IsPressed" Value="True">
                                <Setter TargetName="Bd" Property="Background" Value="#36FFFFFF"/>
                                <Setter TargetName="Bd" Property="BorderBrush" Value="#77000000"/>
                                <Setter Property="RenderTransform">
                                    <Setter.Value>
                                        <ScaleTransform ScaleX="0.97" ScaleY="0.97"/>
                                    </Setter.Value>
                                </Setter>
                                <Setter Property="RenderTransformOrigin" Value="0.5,0.5"/>
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter TargetName="Bd" Property="Opacity" Value="0.45"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="IconBtn" TargetType="Button" BasedOn="{StaticResource IconBtnBase}"/>
        <Style x:Key="IconToggleBtn" TargetType="ToggleButton" BasedOn="{StaticResource IconBtnBase}"/>

        <!-- Consistent icon container -->
        <Style x:Key="IconPath" TargetType="Path">
            <Setter Property="Width" Value="14"/>
            <Setter Property="Height" Value="14"/>
            <Setter Property="Stretch" Value="Uniform"/>
            <Setter Property="Fill" Value="#222"/>
            <Setter Property="SnapsToDevicePixels" Value="True"/>
        </Style>
</Window.Resources>

    <Grid>
        <DockPanel>

        <Menu DockPanel.Dock="Top" Background="{StaticResource PanelBg}">
            <MenuItem Header="File">
                <MenuItem Header="Reload from Disk" Command="{Binding ReloadCommand}" />
                <MenuItem Header="Save Config" Command="{Binding SaveCommand}" />
                <MenuItem Header="Open Categories Folder" Command="{Binding OpenFolderCommand}" />
                <Separator/>
                <MenuItem Header="Restore Original Categories" Command="{Binding RestoreOriginalCategoriesCommand}" />
                <MenuItem Header="Save Prompt to Output" Command="{Binding SaveOutputCommand}" />
                <Separator/>
                <MenuItem Header="Exit" Click="Exit_Click"/>
            </MenuItem>
        </Menu>

        <Grid Margin="16">

	            <!-- Landscape (default, side-by-side) -->
	            <Grid>
	                <Grid.Visibility>
	                    <MultiBinding Converter="{StaticResource AspectToVis}" ConverterParameter="invert">
	                        <Binding RelativeSource="{RelativeSource AncestorType=Window}" Path="ActualWidth"/>
	                        <Binding RelativeSource="{RelativeSource AncestorType=Window}" Path="ActualHeight"/>
	                    </MultiBinding>
	                </Grid.Visibility>

	                <Grid.ColumnDefinitions>
	                    <ColumnDefinition Width="*" MinWidth="520"/>
	                    <ColumnDefinition Width="10"/>
	                    <ColumnDefinition Width="*" MinWidth="420"/>
	                </Grid.ColumnDefinitions>

	                <GridSplitter Grid.Column="1" Width="10" HorizontalAlignment="Stretch" VerticalAlignment="Stretch" Background="Transparent"/>

            <DockPanel Grid.Column="0">


                <StackPanel DockPanel.Dock="Top" Margin="0,0,0,10">


                    <TextBlock FontSize="26" FontWeight="SemiBold" Text="View" Foreground="{StaticResource AccentCyan}"/>


                </StackPanel>



            <TabControl Grid.Column="0" Background="Transparent" BorderThickness="0">
                <TabItem Header="Simple View">
                    <Grid Margin="0">
                        <DockPanel>
<Border Background="{StaticResource PanelBg}" BorderBrush="{StaticResource BorderSoft}" BorderThickness="1" CornerRadius="14" Padding="10">
                    <ListBox x:Name="CategoriesList"
                             ItemsSource="{Binding Categories}"
                             SelectedItem="{Binding ActiveCategory}"
                             Background="Transparent"
                             BorderThickness="0"
                             ScrollViewer.VerticalScrollBarVisibility="Auto"
                             ScrollViewer.HorizontalScrollBarVisibility="Disabled">
                        <!-- Grid layout: fill top-to-bottom, then left-to-right -->
                        <ListBox.ItemsPanel>
                            <ItemsPanelTemplate>
                                <WrapPanel Orientation="Vertical" ItemWidth="460"/>
                            </ItemsPanelTemplate>
                        </ListBox.ItemsPanel>
                        <ListBox.ItemContainerStyle>
                            <Style TargetType="ListBoxItem">
                                <Setter Property="Focusable" Value="False"/>
                                <Setter Property="IsTabStop" Value="False"/>
                                <Setter Property="Padding" Value="0"/>
                                <Setter Property="Margin" Value="0,0,12,12"/>
                                <Setter Property="BorderThickness" Value="0"/>
                                <Setter Property="Background" Value="Transparent"/>
                            </Style>
                        </ListBox.ItemContainerStyle>

                        <ListBox.ItemTemplate>
                            <DataTemplate>
                                <Border CornerRadius="16"
                                        Padding="10"
                                        Background="{Binding Order, Converter={StaticResource PastelByIndex}}">
                                    <Border.Style>
                                        <Style TargetType="Border">
                                            <Setter Property="BorderBrush" Value="{StaticResource BorderSoft}"/>
                                            <Setter Property="BorderThickness" Value="1"/>
                                            <Style.Triggers>
                                                <!-- Highlight drop target when dragging -->
                                                <DataTrigger Binding="{Binding IsDropTarget}" Value="True">
                                                    <Setter Property="BorderBrush" Value="{StaticResource AccentCyan}"/>
                                                    <Setter Property="BorderThickness" Value="3"/>
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </Border.Style>
                                    <StackPanel>
                                        <DockPanel LastChildFill="True">
<CheckBox IsChecked="{Binding Enabled}" VerticalAlignment="Center" Margin="0,0,10,0"/>
                                            <TextBlock FontSize="18" FontWeight="SemiBold" Text="{Binding Name}" VerticalAlignment="Center" Margin="0,0,12,0"/>
	                                            <UniformGrid DockPanel.Dock="Right" Columns="6" Width="186" Margin="16,0,0,0" HorizontalAlignment="Right">
<Button Style="{StaticResource IconBtn}"
                                                        ToolTip="Move category up"
                                                        Command="{Binding DataContext.MoveCategoryUpCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                                        CommandParameter="{Binding}"><Path Style="{StaticResource IconPath}" Data="{StaticResource IcoChevronUp}"/></Button>
                                                <Button Style="{StaticResource IconBtn}"
                                                        ToolTip="Move category down"
                                                        Command="{Binding DataContext.MoveCategoryDownCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                                        CommandParameter="{Binding}"><Path Style="{StaticResource IconPath}" Data="{StaticResource IcoChevronDown}"/></Button>
                                                <Button Style="{StaticResource IconBtn}"
                                                        ToolTip="Select all subcategories"
                                                        Command="{Binding DataContext.SelectAllSubCategoriesCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                                        CommandParameter="{Binding}"><Path Style="{StaticResource IconPath}" Data="{StaticResource IcoSelectAll}"/></Button>
                                                <Button Style="{StaticResource IconBtn}" 
                                                        ToolTip="Select none"
                                                        Command="{Binding DataContext.SelectNoneSubCategoriesCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                                        CommandParameter="{Binding}"><Path Style="{StaticResource IconPath}" Data="{StaticResource IcoSelectNone}"/></Button>
	                                                <ToggleButton Style="{StaticResource IconToggleBtn}"
	                                                             ToolTip="Lock category (exclude from randomization)"
	                                                             IsChecked="{Binding IsLocked}" Content="≡ƒöÆ"/>
	                                                <Button Style="{StaticResource IconBtn}"
	                                                        ToolTip="Randomize this category"
	                                                        Command="{Binding DataContext.RandomizeCategoryOnceCommand, RelativeSource={RelativeSource AncestorType=Window}}"
	                                                        CommandParameter="{Binding}" Content="≡ƒÄ▓"/>
</UniformGrid>
                                            
                                        </DockPanel>

                                        <Expander IsExpanded="{Binding IsExpanded, Mode=TwoWay}" Margin="0,8,0,0">
                                            <StackPanel Margin="0,8,0,0">
                                                <!-- Affixes -->
                                                <Grid Margin="0,0,0,10">
                                                    <Grid.ColumnDefinitions>
                                                        <ColumnDefinition Width="*" />
                                                        <ColumnDefinition Width="*" />
                                                    </Grid.ColumnDefinitions>
                                                    <StackPanel Grid.Column="0" Margin="0,0,8,0">
                                                        <TextBlock Opacity="0.7" Text="Prefix" />
                                                        <TextBox Background="{StaticResource InputCyan}"
                                                                 Text="{Binding Prefix, UpdateSourceTrigger=PropertyChanged}" />
                                                    </StackPanel>
                                                    <StackPanel Grid.Column="1">
                                                        <TextBlock Opacity="0.7" Text="Suffix" />
                                                        <TextBox Background="{StaticResource InputCyan}"
                                                                 Text="{Binding Suffix, UpdateSourceTrigger=PropertyChanged}" />
                                                    </StackPanel>
                                                </Grid>

                                                <TextBlock Opacity="0.7" Margin="0,0,0,6" Text="Subcategories (check to include; click name to edit; use ^ / V to reorder)" />
                                                <ItemsControl ItemsSource="{Binding SubCategories}">
                                                    <ItemsControl.ItemTemplate>
                                                        <DataTemplate>
                                                            <DockPanel Margin="0,0,0,6">
                                                                <CheckBox IsChecked="{Binding Enabled}" VerticalAlignment="Center" Margin="0,0,8,0"/>
	                                                                <UniformGrid DockPanel.Dock="Right" Columns="4" Width="124" Margin="16,0,0,0" HorizontalAlignment="Right">
<Button Style="{StaticResource IconBtn}"
                                                                            ToolTip="Move subcategory up"
                                                                            Command="{Binding DataContext.MoveSubCategoryUpCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                                                            CommandParameter="{Binding}"><Path Style="{StaticResource IconPath}" Data="{StaticResource IcoChevronUp}"/></Button>
                                                                    <Button Style="{StaticResource IconBtn}"
                                                                            ToolTip="Move subcategory down"
                                                                            Command="{Binding DataContext.MoveSubCategoryDownCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                                                            CommandParameter="{Binding}"><Path Style="{StaticResource IconPath}" Data="{StaticResource IcoChevronDown}"/></Button>
	                                                                    <ToggleButton Style="{StaticResource IconToggleBtn}"
	                                                                                 ToolTip="Lock subcategory (exclude from randomization)"
	                                                                                 IsChecked="{Binding IsLocked}" Content="≡ƒöÆ"/>
	                                                                    <Button Style="{StaticResource IconBtn}"
	                                                                            ToolTip="Randomize this subcategory"
	                                                                            Command="{Binding DataContext.RandomizeSubCategoryOnceCommand, RelativeSource={RelativeSource AncestorType=Window}}"
	                                                                            CommandParameter="{Binding}" Content="≡ƒÄ▓"/>
</UniformGrid>
                                                                <Button
                                                                        CommandParameter="{Binding}" Command="{Binding DataContext.SelectSubCategoryCommand, RelativeSource={RelativeSource AncestorType=Window}}" Content="{Binding Name}" Background="Transparent" BorderThickness="0" Padding="6,2" HorizontalAlignment="Left"/></DockPanel>
                                                        </DataTemplate>
                                                    </ItemsControl.ItemTemplate>
                                                </ItemsControl>
                                            </StackPanel>
                                        </Expander>
                                    </StackPanel>
                                </Border>
                            </DataTemplate>
                        </ListBox.ItemTemplate>
                    </ListBox>
                </Border>
            </DockPanel>
                    </Grid>
                </TabItem>
                <TabItem Header="Advanced View">
                    <Grid Margin="0">
                        <DockPanel>
<Border Background="{StaticResource PanelBg}" BorderBrush="{StaticResource BorderSoft}" BorderThickness="1" CornerRadius="14" Padding="10">
                    <TabControl ItemsSource="{Binding Categories}" SelectedItem="{Binding ActiveCategory}" BorderThickness="0" Background="Transparent">
                        
<TabControl.ItemContainerStyle>
    <Style TargetType="TabItem">
        <Setter Property="Margin" Value="0,0,6,0"/>
        <Setter Property="Padding" Value="12,7"/>
        <Setter Property="Background" Value="{Binding Order, Converter={StaticResource PastelByIndex}}"/>
        <Setter Property="BorderBrush" Value="{StaticResource BorderSoft}"/>
        <Setter Property="BorderThickness" Value="1"/>
        <Setter Property="Opacity" Value="1"/>
        <Style.Triggers>
            <DataTrigger Binding="{Binding Enabled}" Value="False">
                <Setter Property="Opacity" Value="0.55"/>
            </DataTrigger>
            <Trigger Property="IsSelected" Value="True">
                <Setter Property="BorderBrush" Value="{StaticResource AccentPink}"/>
                <Setter Property="BorderThickness" Value="2"/>
            </Trigger>
        </Style.Triggers>
    </Style>
</TabControl.ItemContainerStyle>
                        <TabControl.ItemTemplate>
                            <DataTemplate>
                                <!-- Category ordering controls live in the tab header itself (left/right). -->
                                <DockPanel LastChildFill="True" VerticalAlignment="Center">
                                    <Button Style="{StaticResource IconBtn}"
                                            Width="22" Height="22" Margin="0,0,6,0"
                                            ToolTip="Move category left"
                                            Command="{Binding DataContext.MoveCategoryUpCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                            CommandParameter="{Binding}">
                                        <Path Style="{StaticResource IconPath}" Data="{StaticResource IcoChevronLeft}"/>
                                    </Button>
                                    <CheckBox IsChecked="{Binding Enabled}" VerticalAlignment="Center" Margin="0,0,8,0"/>
                                    <TextBlock Text="{Binding Name}" FontWeight="SemiBold" VerticalAlignment="Center"/>
                                    <Button Style="{StaticResource IconBtn}"
                                            DockPanel.Dock="Right"
                                            Width="22" Height="22" Margin="6,0,0,0"
                                            ToolTip="Move category right"
                                            Command="{Binding DataContext.MoveCategoryDownCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                            CommandParameter="{Binding}">
                                        <Path Style="{StaticResource IconPath}" Data="{StaticResource IcoChevronRight}"/>
                                    </Button>
                                </DockPanel>
                            </DataTemplate>
                        </TabControl.ItemTemplate>

                        <TabControl.ContentTemplate>
                            <DataTemplate>
                                
<!-- Make Advanced View reliably scrollable (header + affixes + long lists) -->
<ScrollViewer VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Disabled">
    <Grid Margin="2">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>
        <!-- Category header removed: checkbox moved into tab header (1.8.2.0) -->
<!-- Category affixes -->
        <Grid Grid.Row="0" Margin="0,0,0,10">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>
            <StackPanel Grid.Column="0" Margin="0,0,8,0">
                <TextBlock Opacity="0.7" Text="Category Prefix"/>
                <TextBox Background="{StaticResource InputCyan}" Text="{Binding Prefix, UpdateSourceTrigger=PropertyChanged}"/>
            </StackPanel>
            <StackPanel Grid.Column="1">
                <TextBlock Opacity="0.7" Text="Category Suffix"/>
                <TextBox Background="{StaticResource InputCyan}" Text="{Binding Suffix, UpdateSourceTrigger=PropertyChanged}"/>
            </StackPanel>
        </Grid>

        <!-- Nested tabs: Subcategories -->
        <Grid Grid.Row="1">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
            </Grid.RowDefinitions>

            <DockPanel Grid.Row="0" Margin="0,0,0,8">
                <TextBlock Opacity="0.7" Text="Subcategories" VerticalAlignment="Center"/>
																					<UniformGrid DockPanel.Dock="Right" Columns="4" Width="124" Margin="16,0,0,0" HorizontalAlignment="Right">
                    <Button Style="{StaticResource IconBtn}"
                            ToolTip="Move selected subcategory up"
                            Command="{Binding DataContext.MoveSubCategoryUpCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                            CommandParameter="{Binding DataContext.SelectedSubCategory, RelativeSource={RelativeSource AncestorType=Window}}">
                        <Path Style="{StaticResource IconPath}" Data="{StaticResource IcoChevronUp}"/>
                    </Button>
                    <Button Style="{StaticResource IconBtn}"
                            ToolTip="Move selected subcategory down"
                            Command="{Binding DataContext.MoveSubCategoryDownCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                            CommandParameter="{Binding DataContext.SelectedSubCategory, RelativeSource={RelativeSource AncestorType=Window}}">
                        <Path Style="{StaticResource IconPath}" Data="{StaticResource IcoChevronDown}"/>
                    </Button>
                </UniformGrid>
            </DockPanel>

            <TabControl Grid.Row="1"
                        ItemsSource="{Binding SubCategories}"
                        SelectedItem="{Binding DataContext.SelectedSubCategory, RelativeSource={RelativeSource AncestorType=Window}}"
                        Background="Transparent"
                        BorderThickness="0">

                <TabControl.ItemContainerStyle>
                    <Style TargetType="TabItem">
                        <Setter Property="Margin" Value="0,0,6,0"/>
                        <Setter Property="Padding" Value="10,6"/>
                        <!-- Subcategory tabs inherit the selected category color -->
                        <Setter Property="Background"
                                Value="{Binding DataContext.Order, RelativeSource={RelativeSource AncestorType=TabControl}, Converter={StaticResource PastelByIndex}}"/>
                        <Setter Property="BorderBrush" Value="{StaticResource BorderSoft}"/>
                        <Setter Property="BorderThickness" Value="1"/>
                        <Setter Property="Opacity" Value="1"/>
                        <Style.Triggers>
                            <DataTrigger Binding="{Binding Enabled}" Value="False">
                                <Setter Property="Opacity" Value="0.55"/>
                            </DataTrigger>
                            <Trigger Property="IsSelected" Value="True">
                                <Setter Property="BorderBrush" Value="{StaticResource AccentCyan}"/>
                                <Setter Property="BorderThickness" Value="2"/>
                            </Trigger>
                        </Style.Triggers>
                    </Style>
                </TabControl.ItemContainerStyle>

                <TabControl.ItemTemplate>
                    <DataTemplate>
                        <DockPanel LastChildFill="True">
                            <CheckBox IsChecked="{Binding Enabled}" VerticalAlignment="Center" Margin="0,0,8,0"/>
                            <TextBlock FontWeight="SemiBold" Text="{Binding Name}" VerticalAlignment="Center"/>
                        </DockPanel>
                    </DataTemplate>
                </TabControl.ItemTemplate>

                <TabControl.ContentTemplate>
                    <DataTemplate>
                        <Border CornerRadius="14" Padding="10" Background="{StaticResource PanelBg}" BorderBrush="{StaticResource BorderSoft}" BorderThickness="1" Margin="0,10,0,0">
                            <StackPanel>
                                <Grid Margin="0,0,0,10">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>
                                    <StackPanel Grid.Column="0" Margin="0,0,8,0">
                                        <TextBlock Opacity="0.7" Text="Subcategory Prefix"/>
                                        <TextBox Background="{StaticResource InputCyan}" Text="{Binding Prefix, UpdateSourceTrigger=PropertyChanged}"/>
                                    </StackPanel>
                                    <StackPanel Grid.Column="1">
                                        <TextBlock Opacity="0.7" Text="Subcategory Suffix"/>
                                        <TextBox Background="{StaticResource InputCyan}" Text="{Binding Suffix, UpdateSourceTrigger=PropertyChanged}"/>
                                    </StackPanel>
                                </Grid>

                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="220"/>
                                        <ColumnDefinition Width="14"/>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="14"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>

                                    <!-- Files inside this subcategory -->
                                    <StackPanel Grid.Column="0">
                                        <CheckBox Margin="0,0,0,6"
                                                  IsChecked="{Binding UseAllTxtFiles}"
                                                  >
                                                  <TextBlock Text="Use all enabled files (unchecked = use only selected file)" TextWrapping="Wrap"/>
                                        </CheckBox>
                                        <DockPanel Margin="0,0,0,6">
    <TextBlock Opacity="0.7" Text="Files (.txt)" VerticalAlignment="Center"/>
    <UniformGrid DockPanel.Dock="Right" Columns="2" Width="62" Margin="16,0,0,0" HorizontalAlignment="Right">
        <Button Style="{StaticResource IconBtn}"
                ToolTip="Select all files"
                Command="{Binding DataContext.SelectAllEntriesCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                CommandParameter="{Binding}">
            <Path Style="{StaticResource IconPath}" Data="{StaticResource IcoSelectAll}"/>
        </Button>
        <Button Style="{StaticResource IconBtn}"
                ToolTip="Select none"
                Command="{Binding DataContext.SelectNoneEntriesCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                CommandParameter="{Binding}">
            <Path Style="{StaticResource IconPath}" Data="{StaticResource IcoSelectNone}"/>
        </Button>
    </UniformGrid>
</DockPanel>
                                        <ListBox ItemsSource="{Binding Entries}" Height="140" Background="Transparent" BorderThickness="0"
                                                 ScrollViewer.VerticalScrollBarVisibility="Auto">
                                            <ListBox.ItemTemplate>
                                                <DataTemplate>
                                                    <DockPanel Margin="0,0,0,4">
                                                        <CheckBox IsChecked="{Binding Enabled}" VerticalAlignment="Center" Margin="0,0,6,0"/>
                                                        <Button
                                                                CommandParameter="{Binding}" Command="{Binding DataContext.SelectEntryCommand, RelativeSource={RelativeSource AncestorType=Window}}" Content="{Binding Name}" Background="Transparent" BorderThickness="0" Padding="6,2" HorizontalAlignment="Left"/><UniformGrid DockPanel.Dock="Right" Columns="2" Width="62" Margin="10,0,0,0" HorizontalAlignment="Right">
                                                            <Button Style="{StaticResource IconBtn}" ToolTip="Move file up"
                                                                    Command="{Binding DataContext.MoveEntryUpCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                                                    CommandParameter="{Binding}">
                                                                <Path Style="{StaticResource IconPath}" Data="{StaticResource IcoChevronUp}"/>
                                                            </Button>
                                                            <Button Style="{StaticResource IconBtn}" ToolTip="Move file down"
                                                                    Command="{Binding DataContext.MoveEntryDownCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                                                    CommandParameter="{Binding}">
                                                                <Path Style="{StaticResource IconPath}" Data="{StaticResource IcoChevronDown}"/>
                                                            </Button>
                                                        </UniformGrid>
                                                    </DockPanel>
                                                </DataTemplate>
                                            </ListBox.ItemTemplate>
                                        </ListBox>
                                    </StackPanel>

                                    <!-- Preview entries -->
                                    <StackPanel Grid.Column="2">
                                        <TextBlock Opacity="0.7" Text="{Binding EntrySummary}" Margin="0,0,0,6"/>
                                        <ListBox ItemsSource="{Binding PreviewEntries}" Height="140" ScrollViewer.VerticalScrollBarVisibility="Auto"/>
                                    </StackPanel>

                                    <!-- Current chosen entry -->
                                    <StackPanel Grid.Column="4">
                                        <TextBlock Opacity="0.7" Text="Current entry in prompt" Margin="0,0,0,6"/>
                                        <TextBox Background="#FFF7FBFF" IsReadOnly="True" TextWrapping="Wrap" AcceptsReturn="True" Height="140"
                                                 Text="{Binding CurrentEntry}"/>
                                    </StackPanel>
                                </Grid>
                            </StackPanel>
                        </Border>
                    </DataTemplate>
                </TabControl.ContentTemplate>

            </TabControl>


            </Grid>
    </Grid>
</ScrollViewer>
                            </DataTemplate>
                        </TabControl.ContentTemplate>
                    </TabControl>
                </Border>
            </DockPanel>
                    </Grid>
                </TabItem>
                <TabItem Header="Search" DataContext="{Binding SearchViewModel}">
                    <Border Background="{StaticResource PanelBg}" BorderBrush="{StaticResource BorderSoft}" BorderThickness="1" CornerRadius="14" Padding="12">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>

                            <StackPanel Grid.Row="0" Margin="0,0,0,10">
                                <DockPanel LastChildFill="True">
                                    <TextBox Text="{Binding SearchQuery, UpdateSourceTrigger=PropertyChanged}"
                                             Background="{StaticResource InputCyan}"
                                             MinWidth="220"
                                             Margin="0,0,8,0"/>
                                    <Button Content="Add Tag" Margin="0,0,8,0" Command="{Binding AddTagCommand}"/>
                                </DockPanel>
                                <ItemsControl ItemsSource="{Binding SuggestedTags}" Margin="0,8,0,0">
                                    <ItemsControl.ItemsPanel>
                                        <ItemsPanelTemplate>
                                            <WrapPanel/>
                                        </ItemsPanelTemplate>
                                    </ItemsControl.ItemsPanel>
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <Button Content="{Binding DisplayText}"
                                                    Padding="8,4"
                                                    Margin="0,0,6,6"
                                                    Command="{Binding DataContext.AddTagCommand, RelativeSource={RelativeSource AncestorType=ItemsControl}}"
                                                    CommandParameter="{Binding Name}"/>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                            </StackPanel>

                            <StackPanel Grid.Row="1" Margin="0,0,0,10">
                                <TextBlock Text="Selected tags" Opacity="0.7" Margin="0,0,0,6"/>
                                <ItemsControl ItemsSource="{Binding SelectedTags}">
                                    <ItemsControl.ItemsPanel>
                                        <ItemsPanelTemplate>
                                            <WrapPanel/>
                                        </ItemsPanelTemplate>
                                    </ItemsControl.ItemsPanel>
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <Border Background="{StaticResource InputCyan}" CornerRadius="10" Padding="6,3" Margin="0,0,6,6">
                                                <DockPanel>
                                                    <TextBlock Text="{Binding DisplayText}" Margin="0,0,6,0"/>
                                                    <Button Content="x"
                                                            Padding="0"
                                                            Width="18"
                                                            Height="18"
                                                            Command="{Binding DataContext.RemoveTagCommand, RelativeSource={RelativeSource AncestorType=ItemsControl}}"
                                                            CommandParameter="{Binding Name}"/>
                                                </DockPanel>
                                            </Border>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                            </StackPanel>

                            <StackPanel Grid.Row="2" Margin="0,0,0,10">
                                <TextBlock Text="Related tags" Opacity="0.7" Margin="0,0,0,6"/>
                                <Border Background="{StaticResource PanelBg}"
                                        BorderBrush="{StaticResource BorderSoft}"
                                        BorderThickness="1"
                                        CornerRadius="10"
                                        Padding="8">
                                    <Grid>
                                        <ItemsControl ItemsSource="{Binding RelatedTags}">
                                            <ItemsControl.ItemsPanel>
                                                <ItemsPanelTemplate>
                                                    <WrapPanel/>
                                                </ItemsPanelTemplate>
                                            </ItemsControl.ItemsPanel>
                                            <ItemsControl.ItemTemplate>
                                                <DataTemplate>
                                                    <Button Content="{Binding DisplayText}"
                                                            Padding="8,4"
                                                            Margin="0,0,6,6"
                                                            Command="{Binding DataContext.AddTagCommand, RelativeSource={RelativeSource AncestorType=ItemsControl}}"
                                                            CommandParameter="{Binding Name}"/>
                                                </DataTemplate>
                                            </ItemsControl.ItemTemplate>
                                        </ItemsControl>
                                        <TextBlock Text="Related tags will appear here." Opacity="0.6">
                                            <TextBlock.Style>
                                                <Style TargetType="TextBlock">
                                                    <Setter Property="Visibility" Value="Collapsed"/>
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding RelatedTags.Count}" Value="0">
                                                            <Setter Property="Visibility" Value="Visible"/>
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </TextBlock.Style>
                                        </TextBlock>
                                    </Grid>
                                </Border>
                            </StackPanel>

                            <Border Grid.Row="3" Background="{StaticResource PanelBg}" BorderBrush="{StaticResource BorderSoft}" BorderThickness="1" CornerRadius="10" Padding="8">
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="16"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>

                                    <StackPanel Grid.Column="0">
                                        <TextBlock Text="Found files" Opacity="0.7" Margin="0,0,0,6"/>
                                        <ScrollViewer VerticalScrollBarVisibility="Auto">
                                            <ItemsControl ItemsSource="{Binding Results}">
                                                <ItemsControl.ItemsPanel>
                                                    <ItemsPanelTemplate>
                                                        <WrapPanel/>
                                                    </ItemsPanelTemplate>
                                                </ItemsControl.ItemsPanel>
                                                <ItemsControl.ItemTemplate>
                                                    <DataTemplate>
                                                        <Button Padding="10,4"
                                                                Margin="0,0,6,6"
                                                                Background="{StaticResource InputCyan}"
                                                                ToolTip="{Binding Path}"
                                                                Command="{Binding DataContext.SelectFileCommand, RelativeSource={RelativeSource AncestorType=ItemsControl}}"
                                                                CommandParameter="{Binding}">
                                                            <Button.Content>
                                                                <TextBlock TextWrapping="Wrap" Width="240">
                                                                    <Run Text="{Binding Path, Converter={StaticResource CategoryPathConverter}}"/>
                                                                    <Run Text="{Binding RelevancePercent, StringFormat=' ({0}%)'}"/>
                                                                </TextBlock>
                                                            </Button.Content>
                                                        </Button>
                                                    </DataTemplate>
                                                </ItemsControl.ItemTemplate>
                                            </ItemsControl>
                                        </ScrollViewer>
                                    </StackPanel>

                                    <StackPanel Grid.Column="2">
                                        <TextBlock Text="Selected files" Opacity="0.7" Margin="0,0,0,6"/>
                                        <ScrollViewer VerticalScrollBarVisibility="Auto">
                                            <ItemsControl ItemsSource="{Binding SelectedFiles}">
                                                <ItemsControl.ItemsPanel>
                                                    <ItemsPanelTemplate>
                                                        <StackPanel/>
                                                    </ItemsPanelTemplate>
                                                </ItemsControl.ItemsPanel>
                                                <ItemsControl.ItemTemplate>
                                                    <DataTemplate>
                                                        <StackPanel Orientation="Horizontal" Margin="0,0,0,6">
                                                            <Button Padding="10,4"
                                                                    Margin="0,0,8,0"
                                                                    Background="{StaticResource InputCyan}"
                                                                    ToolTip="{Binding Path}"
                                                                    Command="{Binding DataContext.RemoveSelectedFileCommand, RelativeSource={RelativeSource AncestorType=ItemsControl}}"
                                                                    CommandParameter="{Binding}">
                                                                <Button.Content>
                                                                    <TextBlock TextWrapping="Wrap" Width="240">
                                                                        <Run Text="{Binding Path, Converter={StaticResource CategoryPathConverter}}"/>
                                                                        <Run Text="{Binding RelevancePercent, StringFormat=' ({0}%)'}"/>
                                                                    </TextBlock>
                                                                </Button.Content>
                                                            </Button>
                                                            <Button Content="↑"
                                                                    Width="24"
                                                                    Height="24"
                                                                    Margin="0,0,4,0"
                                                                    Command="{Binding DataContext.MoveSelectedFileUpCommand, RelativeSource={RelativeSource AncestorType=ItemsControl}}"
                                                                    CommandParameter="{Binding}"/>
                                                            <Button Content="↓"
                                                                    Width="24"
                                                                    Height="24"
                                                                    Margin="0,0,4,0"
                                                                    Command="{Binding DataContext.MoveSelectedFileDownCommand, RelativeSource={RelativeSource AncestorType=ItemsControl}}"
                                                                    CommandParameter="{Binding}"/>
                                                            <Button Content="x"
                                                                    Width="24"
                                                                    Height="24"
                                                                    Command="{Binding DataContext.RemoveSelectedFileCommand, RelativeSource={RelativeSource AncestorType=ItemsControl}}"
                                                                    CommandParameter="{Binding}"/>
                                                        </StackPanel>
                                                    </DataTemplate>
                                                </ItemsControl.ItemTemplate>
                                            </ItemsControl>
                                        </ScrollViewer>
                                    </StackPanel>
                                </Grid>
                            </Border>

                            <Grid Grid.Row="4" Margin="0,10,0,0">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                <StackPanel Grid.Column="0">
                                    <TextBlock Text="{Binding IndexStatusMessage}" Opacity="0.75">
                                        <TextBlock.Style>
                                            <Style TargetType="TextBlock">
                                                <Setter Property="Visibility" Value="Collapsed"/>
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding HasIndexStatusMessage}" Value="True">
                                                        <Setter Property="Visibility" Value="Visible"/>
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </TextBlock.Style>
                                    </TextBlock>
                                    <TextBlock Text="No files found in Categories." Opacity="0.7">
                                        <TextBlock.Style>
                                            <Style TargetType="TextBlock">
                                                <Setter Property="Visibility" Value="Collapsed"/>
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding State}" Value="{x:Static viewModels:SearchState.EmptyIndex}">
                                                        <Setter Property="Visibility" Value="Visible"/>
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </TextBlock.Style>
                                    </TextBlock>
                                    <TextBlock Text="No files match the selected tags." Opacity="0.7">
                                        <TextBlock.Style>
                                            <Style TargetType="TextBlock">
                                                <Setter Property="Visibility" Value="Collapsed"/>
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding State}" Value="{x:Static viewModels:SearchState.NoResults}">
                                                        <Setter Property="Visibility" Value="Visible"/>
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </TextBlock.Style>
                                    </TextBlock>
                                    <TextBlock Text="{Binding ErrorMessage}" Foreground="{StaticResource AccentPink}" TextWrapping="Wrap">
                                        <TextBlock.Style>
                                            <Style TargetType="TextBlock">
                                                <Setter Property="Visibility" Value="Collapsed"/>
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding State}" Value="{x:Static viewModels:SearchState.Error}">
                                                        <Setter Property="Visibility" Value="Visible"/>
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </TextBlock.Style>
                                    </TextBlock>
                                </StackPanel>
                                <Button Grid.Column="1"
                                        Style="{StaticResource IconBtn}"
                                        Margin="8,0,0,0"
                                        VerticalAlignment="Center"
                                        ToolTip="Refresh tags"
                                        Command="{Binding RefreshCommand}">
                                    <Path Style="{StaticResource IconPath}" Data="{StaticResource IcoRefresh}"/>
                                </Button>
                            </Grid>
                        </Grid>
                    </Border>
                        </TabItem>
                        
                    </TabControl>

            </DockPanel>

            <!-- Prompt -->
            <controls:PromptPanel Grid.Column="2"/>


	        </Grid>

	        <!-- Portrait (stacked) -->
	        <Grid>
	            <Grid.Visibility>
	                <MultiBinding Converter="{StaticResource AspectToVis}">
	                    <Binding RelativeSource="{RelativeSource AncestorType=Window}" Path="ActualWidth"/>
	                    <Binding RelativeSource="{RelativeSource AncestorType=Window}" Path="ActualHeight"/>
	                </MultiBinding>
	            </Grid.Visibility>
	            <Grid.RowDefinitions>
	                <RowDefinition Height="*"/>
	                <RowDefinition Height="10"/>
	                <RowDefinition Height="*"/>
	            </Grid.RowDefinitions>
	
	            <GridSplitter Grid.Row="1" Height="10" HorizontalAlignment="Stretch" VerticalAlignment="Stretch" Background="Transparent"/>
	
	            <!-- Tabs (stacked top) -->
	            <TabControl Grid.Row="0" Background="Transparent" BorderThickness="0">
	                <TabItem Header="Simple View">
	                    <Grid Margin="0">
	                        <DockPanel>
	                            <StackPanel DockPanel.Dock="Top" Margin="0,0,0,10">
	                                <TextBlock FontSize="26" FontWeight="SemiBold" Text="Simple View" Foreground="{StaticResource AccentPink}"/>
	                                <TextBlock Opacity="0.75" FontSize="13" Text="(Categories View)"/>
	                                <TextBlock Margin="0,2,0,0" Opacity="0.75" Text="Check categories and subcategories to include. Use the arrow buttons to reorder."/>
	                            </StackPanel>
	
	                            <Border Background="{StaticResource PanelBg}" BorderBrush="{StaticResource BorderSoft}" BorderThickness="1" CornerRadius="14" Padding="10">
	                                <ListBox ItemsSource="{Binding Categories}" SelectedItem="{Binding ActiveCategory}" Background="Transparent" BorderThickness="0"
                                                     ScrollViewer.VerticalScrollBarVisibility="Auto" ScrollViewer.HorizontalScrollBarVisibility="Disabled">
	                                    <ListBox.ItemsPanel>
	                                        <ItemsPanelTemplate>
	                                            <WrapPanel Orientation="Vertical" ItemWidth="460"/>
	                                        </ItemsPanelTemplate>
	                                    </ListBox.ItemsPanel>
	                                    <ListBox.ItemContainerStyle>
	                                        <Style TargetType="ListBoxItem">
	                                            <Setter Property="Focusable" Value="False"/>
	                                            <Setter Property="IsTabStop" Value="False"/>
	                                            <Setter Property="Padding" Value="0"/>
	                                            <Setter Property="Margin" Value="0,0,12,12"/>
	                                            <Setter Property="BorderThickness" Value="0"/>
	                                            <Setter Property="Background" Value="Transparent"/>
	                                        </Style>
	                                    </ListBox.ItemContainerStyle>
	
	                                    <ListBox.ItemTemplate>
	                                        <DataTemplate>
	                                            <Border CornerRadius="16" Padding="10" Background="{Binding Order, Converter={StaticResource PastelByIndex}}" BorderBrush="{StaticResource BorderSoft}" BorderThickness="1">
	                                                <StackPanel>
	                                                    <DockPanel>
	                                                        <CheckBox IsChecked="{Binding Enabled}" VerticalAlignment="Center" Margin="0,0,10,0"/>
	                                                        <TextBlock FontSize="18" FontWeight="SemiBold" Text="{Binding Name}" VerticalAlignment="Center" Margin="0,0,12,0"/>
														<UniformGrid DockPanel.Dock="Right" Columns="6" Width="186" Margin="16,0,0,0" HorizontalAlignment="Right">
<Button Style="{StaticResource IconBtn}" ToolTip="Move category up"
	                                                                    Command="{Binding DataContext.MoveCategoryUpCommand, RelativeSource={RelativeSource AncestorType=Window}}" CommandParameter="{Binding}"><Path Style="{StaticResource IconPath}" Data="{StaticResource IcoChevronUp}"/></Button>
	                                                            <Button Style="{StaticResource IconBtn}" ToolTip="Move category down"
	                                                                    Command="{Binding DataContext.MoveCategoryDownCommand, RelativeSource={RelativeSource AncestorType=Window}}" CommandParameter="{Binding}"><Path Style="{StaticResource IconPath}" Data="{StaticResource IcoChevronDown}"/></Button>
	                                                            <Button Style="{StaticResource IconBtn}" ToolTip="Select all subcategories"
	                                                                    Command="{Binding DataContext.SelectAllSubCategoriesCommand, RelativeSource={RelativeSource AncestorType=Window}}" CommandParameter="{Binding}"><Path Style="{StaticResource IconPath}" Data="{StaticResource IcoSelectAll}"/></Button>
														<Button Style="{StaticResource IconBtn}"  ToolTip="Select no subcategories"
														        Command="{Binding DataContext.SelectNoneSubCategoriesCommand, RelativeSource={RelativeSource AncestorType=Window}}" CommandParameter="{Binding}"><Path Style="{StaticResource IconPath}" Data="{StaticResource IcoSelectNone}"/></Button>
														<ToggleButton Style="{StaticResource IconToggleBtn}" ToolTip="Lock category (exclude from randomization)" IsChecked="{Binding IsLocked}" Content="≡ƒöÆ"/>
														<Button Style="{StaticResource IconBtn}" ToolTip="Randomize this category" Command="{Binding DataContext.RandomizeCategoryOnceCommand, RelativeSource={RelativeSource AncestorType=Window}}" CommandParameter="{Binding}" Content="≡ƒÄ▓"/>
	</UniformGrid>
	                                                    </DockPanel>
	                                                    <Expander IsExpanded="{Binding IsExpanded, Mode=TwoWay}" Margin="0,8,0,0">
	                                                        <StackPanel Margin="0,8,0,0">
	                                                            <TextBlock Opacity="0.7" Margin="0,0,0,6" Text="Subcategories"/>
	                                                            <ItemsControl ItemsSource="{Binding SubCategories}">
	                                                                <ItemsControl.ItemTemplate>
	                                                                    <DataTemplate>
	                                                                        <DockPanel Margin="0,0,0,6">
	                                                                            <CheckBox IsChecked="{Binding Enabled}" VerticalAlignment="Center" Margin="0,0,8,0"/>
																<UniformGrid DockPanel.Dock="Right" Columns="4" Width="124" Margin="16,0,0,0" HorizontalAlignment="Right">
<Button Style="{StaticResource IconBtn}" ToolTip="Move subcategory up"
	                                                                                        Command="{Binding DataContext.MoveSubCategoryUpCommand, RelativeSource={RelativeSource AncestorType=Window}}" CommandParameter="{Binding}"><Path Style="{StaticResource IconPath}" Data="{StaticResource IcoChevronUp}"/></Button>
																						<Button Style="{StaticResource IconBtn}"  ToolTip="Move subcategory down"
																						        Command="{Binding DataContext.MoveSubCategoryDownCommand, RelativeSource={RelativeSource AncestorType=Window}}" CommandParameter="{Binding}"><Path Style="{StaticResource IconPath}" Data="{StaticResource IcoChevronDown}"/></Button>
																						<ToggleButton Style="{StaticResource IconToggleBtn}" ToolTip="Lock subcategory (exclude from randomization)" IsChecked="{Binding IsLocked}" Content="≡ƒöÆ"/>
																						<Button Style="{StaticResource IconBtn}" ToolTip="Randomize this subcategory" Command="{Binding DataContext.RandomizeSubCategoryOnceCommand, RelativeSource={RelativeSource AncestorType=Window}}" CommandParameter="{Binding}" Content="≡ƒÄ▓"/>
</UniformGrid>
	                                                                            <Button CommandParameter="{Binding}" Command="{Binding DataContext.SelectSubCategoryCommand, RelativeSource={RelativeSource AncestorType=Window}}" Content="{Binding Name}" Background="Transparent" BorderThickness="0" Padding="6,2" HorizontalAlignment="Left"/></DockPanel>
	                                                                    </DataTemplate>
	                                                                </ItemsControl.ItemTemplate>
	                                                            </ItemsControl>
	                                                        </StackPanel>
	                                                    </Expander>
	                                                </StackPanel>
	                                            </Border>
	                                        </DataTemplate>
	                                    </ListBox.ItemTemplate>
	                                </ListBox>
	                            </Border>
	                        </DockPanel>
	                    </Grid>
	                </TabItem>
	                <TabItem Header="Advanced View">
	                    <!-- In portrait, Advanced View stays available; it uses the same VM bindings -->
	                    <ScrollViewer VerticalScrollBarVisibility="Auto">
	                        <Border Background="{StaticResource PanelBg}" BorderBrush="{StaticResource BorderSoft}" BorderThickness="1" CornerRadius="14" Padding="10">
	                            <TabControl ItemsSource="{Binding Categories}" SelectedItem="{Binding ActiveCategory}" BorderThickness="0" Background="Transparent">
	                                
<TabControl.ItemContainerStyle>
    <Style TargetType="TabItem">
        <Setter Property="Margin" Value="0,0,6,0"/>
        <Setter Property="Padding" Value="12,7"/>
        <Setter Property="Background" Value="{Binding Order, Converter={StaticResource PastelByIndex}}"/>
        <Setter Property="BorderBrush" Value="{StaticResource BorderSoft}"/>
        <Setter Property="BorderThickness" Value="1"/>
        <Setter Property="Opacity" Value="1"/>
        <Style.Triggers>
            <DataTrigger Binding="{Binding Enabled}" Value="False">
                <Setter Property="Opacity" Value="0.55"/>
            </DataTrigger>
            <Trigger Property="IsSelected" Value="True">
                <Setter Property="BorderBrush" Value="{StaticResource AccentPink}"/>
                <Setter Property="BorderThickness" Value="2"/>
            </Trigger>
        </Style.Triggers>
    </Style>
</TabControl.ItemContainerStyle>
	                                <TabControl.ItemTemplate>
	                                    <DataTemplate>
	                                        <!-- Category ordering controls live in the tab header itself (left/right). -->
	                                        <DockPanel LastChildFill="True" VerticalAlignment="Center">
	                                            <Button Style="{StaticResource IconBtn}"
	                                                    Width="22" Height="22" Margin="0,0,6,0"
	                                                    ToolTip="Move category left"
	                                                    Command="{Binding DataContext.MoveCategoryUpCommand, RelativeSource={RelativeSource AncestorType=Window}}"
	                                                    CommandParameter="{Binding}">
	                                                <Path Style="{StaticResource IconPath}" Data="{StaticResource IcoChevronLeft}"/>
	                                            </Button>
	                                            <CheckBox IsChecked="{Binding Enabled}" VerticalAlignment="Center" Margin="0,0,8,0"/>
	                                            <TextBlock Text="{Binding Name}" FontWeight="SemiBold" VerticalAlignment="Center"/>
	                                            <Button Style="{StaticResource IconBtn}"
	                                                    DockPanel.Dock="Right"
	                                                    Width="22" Height="22" Margin="6,0,0,0"
	                                                    ToolTip="Move category right"
	                                                    Command="{Binding DataContext.MoveCategoryDownCommand, RelativeSource={RelativeSource AncestorType=Window}}"
	                                                    CommandParameter="{Binding}">
	                                                <Path Style="{StaticResource IconPath}" Data="{StaticResource IcoChevronRight}"/>
	                                            </Button>
	                                        </DockPanel>
	                                    </DataTemplate>
	                                </TabControl.ItemTemplate>
	                                <TabControl.ContentTemplate>
	                                    <DataTemplate>
	                                        <StackPanel>
	                                            <UniformGrid HorizontalAlignment="Right" Columns="2" Width="62" Margin="0,0,0,8">
	                                                <Button Style="{StaticResource IconBtn}" ToolTip="Select all subcategories"
	                                                        Command="{Binding DataContext.SelectAllSubCategoriesCommand, RelativeSource={RelativeSource AncestorType=Window}}" CommandParameter="{Binding}">
	                                                    <Path Style="{StaticResource IconPath}" Data="{StaticResource IcoSelectAll}"/>
	                                                </Button>
	                                                <Button Style="{StaticResource IconBtn}" ToolTip="Select none"
	                                                        Command="{Binding DataContext.SelectNoneSubCategoriesCommand, RelativeSource={RelativeSource AncestorType=Window}}" CommandParameter="{Binding}">
	                                                    <Path Style="{StaticResource IconPath}" Data="{StaticResource IcoSelectNone}"/>
	                                                </Button>
	                                            </UniformGrid>
	                                            
<TextBlock Opacity="0.7" Text="Subcategories" Margin="0,0,0,6"/>

<TabControl ItemsSource="{Binding SubCategories}"
            SelectedItem="{Binding DataContext.SelectedSubCategory, RelativeSource={RelativeSource AncestorType=Window}}"
            Background="Transparent" BorderThickness="0">
    <TabControl.ItemContainerStyle>
        <Style TargetType="TabItem">
            <Setter Property="Margin" Value="0,0,6,0"/>
            <Setter Property="Padding" Value="10,6"/>
            <Setter Property="Background"
                    Value="{Binding DataContext.Order, RelativeSource={RelativeSource AncestorType=TabControl}, Converter={StaticResource PastelByIndex}}"/>
            <Setter Property="BorderBrush" Value="{StaticResource BorderSoft}"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="Opacity" Value="1"/>
            <Style.Triggers>
                <DataTrigger Binding="{Binding Enabled}" Value="False">
                    <Setter Property="Opacity" Value="0.55"/>
                </DataTrigger>
                <Trigger Property="IsSelected" Value="True">
                    <Setter Property="BorderBrush" Value="{StaticResource AccentCyan}"/>
                    <Setter Property="BorderThickness" Value="2"/>
                </Trigger>
            </Style.Triggers>
        </Style>
    </TabControl.ItemContainerStyle>

    <TabControl.ItemTemplate>
        <DataTemplate>
            <DockPanel>
                <CheckBox IsChecked="{Binding Enabled}" VerticalAlignment="Center" Margin="0,0,8,0"/>
                <TextBlock FontWeight="SemiBold" Text="{Binding Name}" VerticalAlignment="Center"/>
            </DockPanel>
        </DataTemplate>
    </TabControl.ItemTemplate>

    <TabControl.ContentTemplate>
        <DataTemplate>
            <StackPanel Margin="0,10,0,0">
                <UniformGrid Columns="2" HorizontalAlignment="Right" Width="62" Margin="0,0,0,8">
                    <Button Style="{StaticResource IconBtn}" ToolTip="Move subcategory up"
                            Command="{Binding DataContext.MoveSubCategoryUpCommand, RelativeSource={RelativeSource AncestorType=Window}}" CommandParameter="{Binding}">
                        <Path Style="{StaticResource IconPath}" Data="{StaticResource IcoChevronUp}"/>
                    </Button>
                    <Button Style="{StaticResource IconBtn}" ToolTip="Move subcategory down"
                            Command="{Binding DataContext.MoveSubCategoryDownCommand, RelativeSource={RelativeSource AncestorType=Window}}" CommandParameter="{Binding}">
                        <Path Style="{StaticResource IconPath}" Data="{StaticResource IcoChevronDown}"/>
                    </Button>
                </UniformGrid>

                <Grid Margin="0,0,0,10">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>
                    <StackPanel Grid.Column="0" Margin="0,0,8,0">
                        <TextBlock Opacity="0.7" Text="Subcategory Prefix"/>
                        <TextBox Background="{StaticResource InputCyan}" Text="{Binding Prefix, UpdateSourceTrigger=PropertyChanged}"/>
                    </StackPanel>
                    <StackPanel Grid.Column="1">
                        <TextBlock Opacity="0.7" Text="Subcategory Suffix"/>
                        <TextBox Background="{StaticResource InputCyan}" Text="{Binding Suffix, UpdateSourceTrigger=PropertyChanged}"/>
                    </StackPanel>
                </Grid>

                <CheckBox Margin="0,0,0,6"
                          IsChecked="{Binding UseAllTxtFiles}"
                          >
                                                  <TextBlock Text="Use all enabled files (unchecked = use only selected file)" TextWrapping="Wrap"/>
                                        </CheckBox>

                <DockPanel Margin="0,0,0,6">
    <TextBlock Opacity="0.7" Text="Files (.txt)" VerticalAlignment="Center"/>
    <UniformGrid DockPanel.Dock="Right" Columns="2" Width="62" Margin="16,0,0,0" HorizontalAlignment="Right">
        <Button Style="{StaticResource IconBtn}"
                ToolTip="Select all files"
                Command="{Binding DataContext.SelectAllEntriesCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                CommandParameter="{Binding}">
            <Path Style="{StaticResource IconPath}" Data="{StaticResource IcoSelectAll}"/>
        </Button>
        <Button Style="{StaticResource IconBtn}"
                ToolTip="Select none"
                Command="{Binding DataContext.SelectNoneEntriesCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                CommandParameter="{Binding}">
            <Path Style="{StaticResource IconPath}" Data="{StaticResource IcoSelectNone}"/>
        </Button>
    </UniformGrid>
</DockPanel>
                <ListBox ItemsSource="{Binding Entries}" Background="Transparent" BorderThickness="0"
                         ScrollViewer.VerticalScrollBarVisibility="Auto">
                    <ListBox.ItemTemplate>
                        <DataTemplate>
                            <DockPanel Margin="0,0,0,6">
                                <CheckBox IsChecked="{Binding Enabled}" VerticalAlignment="Center" Margin="0,0,8,0"/>
                                <Button
                                        CommandParameter="{Binding}" Command="{Binding DataContext.SelectEntryCommand, RelativeSource={RelativeSource AncestorType=Window}}" Content="{Binding Name}" Background="Transparent" BorderThickness="0" Padding="6,2" HorizontalAlignment="Left"/><UniformGrid DockPanel.Dock="Right" Columns="2" Width="62" Margin="16,0,0,0" HorizontalAlignment="Right">
                                    <Button Style="{StaticResource IconBtn}" ToolTip="Move file up"
                                            Command="{Binding DataContext.MoveEntryUpCommand, RelativeSource={RelativeSource AncestorType=Window}}" CommandParameter="{Binding}">
                                        <Path Style="{StaticResource IconPath}" Data="{StaticResource IcoChevronUp}"/>
                                    </Button>
                                    <Button Style="{StaticResource IconBtn}" ToolTip="Move file down"
                                            Command="{Binding DataContext.MoveEntryDownCommand, RelativeSource={RelativeSource AncestorType=Window}}" CommandParameter="{Binding}">
                                        <Path Style="{StaticResource IconPath}" Data="{StaticResource IcoChevronDown}"/>
                                    </Button>
                                </UniformGrid>
                            </DockPanel>
                        </DataTemplate>
                    </ListBox.ItemTemplate>
                </ListBox>
            </StackPanel>
        </DataTemplate>
    </TabControl.ContentTemplate>
</TabControl>
	                                        </StackPanel>
	                                    </DataTemplate>
	                                </TabControl.ContentTemplate>
	                            </TabControl>
	                        </Border>
	                    </ScrollViewer>
	                </TabItem>
	            </TabControl>

	            <!-- Prompt (stacked bottom) -->
            <controls:PromptPanel Grid.Row="2"/>
	        </Grid>

	    </Grid>
	</DockPanel>

        <!-- Fullscreen image overlay: close via Γ£ò only; image supports zoom (wheel/up/down) + pan (drag) + prev/next (edges/left-right) -->
	        <Grid x:Name="ImageOverlayRoot" Panel.ZIndex="999"
              Background="#88000000"
	              Visibility="{Binding IsImageOverlayVisible, Converter={StaticResource BoolToVis}}"
	              MouseDown="ImageOverlayRoot_MouseDown">
            <Grid.RowDefinitions>
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <!-- Image layer -->
            <Grid Grid.Row="0" Panel.ZIndex="5">
	                <controls:ZoomPanImage x:Name="OverlayZoomPan"
	                                      Source="{Binding OverlayImage}"
	                                      ClickLeftCommand="{Binding OverlayPrevCommand}"
	                                      ClickRightCommand="{Binding OverlayNextCommand}"
	                                      CloseCommand="{Binding HideImageOverlayCommand}"/>

                <Button HorizontalAlignment="Right" VerticalAlignment="Top" Margin="12" Width="40" Height="40"
                        Background="#AA000000" Foreground="#FFF" BorderBrush="#33FFFFFF" BorderThickness="1"
                        Content="Γ£ò" FontSize="16" FontWeight="SemiBold"
                        Command="{Binding HideImageOverlayCommand}"/>
            </Grid>

            <!-- Bottom info bar: 3-panel header grid; expands upward to show full details -->
            <Border Grid.Row="1" Background="#CC0B0B0B" BorderBrush="#33FFFFFF" BorderThickness="1" Padding="10">
	                <Grid>
	                    <Grid.RowDefinitions>
	                        <RowDefinition Height="56"/>
	                        <RowDefinition Height="Auto"/>
	                    </Grid.RowDefinitions>

	                    <!-- Header grid (always visible) -->
	                    <Grid Grid.Row="0" ClipToBounds="True">
	                        <Grid.ColumnDefinitions>
	                            <ColumnDefinition Width="2*"/>
	                            <ColumnDefinition Width="*"/>
	                            <ColumnDefinition Width="*"/>
	                        </Grid.ColumnDefinitions>

	                        <!-- Panel 1: prompt (wrap to two lines) -->
                                <Button Grid.Column="0" Background="Transparent" BorderThickness="0" Padding="0"
                                        Command="{Binding ToggleOverlayDetailsCommand}">
                                    <!-- WPF TextBlock lacks MaxLines; cap at ~2 lines via line height/max height. -->
                                    <TextBlock Foreground="#FFF" FontSize="13" TextWrapping="Wrap"
                                               LineStackingStrategy="BlockLineHeight" LineHeight="16" MaxHeight="32"
                                               TextTrimming="CharacterEllipsis"
                                               Text="{Binding OverlaySelectedItem.PromptShort}"
                                               ToolTip="{Binding OverlaySelectedItem.Prompt}"/>
                                </Button>

	                        <!-- Panel 2: model / steps / cfg -->
	                        <StackPanel Grid.Column="1" Margin="12,0,0,0" VerticalAlignment="Center">
	                            <TextBlock Foreground="#FFF" Opacity="0.85" FontSize="12" TextWrapping="NoWrap" TextTrimming="CharacterEllipsis"
	                                       Text="{Binding OverlaySelectedItem.Model}"/>
	                            <TextBlock Foreground="#FFF" Opacity="0.65" FontSize="11"
	                                       Text="{Binding OverlaySelectedItem.Steps, StringFormat=Steps: {0}}"/>
	                            <TextBlock Foreground="#FFF" Opacity="0.65" FontSize="11"
	                                       Text="{Binding OverlaySelectedItem.CfgScale, StringFormat=CFG: {0}}"/>
	                        </StackPanel>

	                        <!-- Panel 3: seed / loras -->
	                        <StackPanel Grid.Column="2" Margin="12,0,0,0" VerticalAlignment="Center">
	                            <TextBlock Foreground="#FFF" Opacity="0.85" FontSize="12"
	                                       Text="{Binding OverlaySelectedItem.Seed, StringFormat=Seed: {0}}"/>
	                            <TextBlock Foreground="#FFF" Opacity="0.65" FontSize="11" TextWrapping="NoWrap" TextTrimming="CharacterEllipsis"
	                                       Text="{Binding OverlaySelectedItem.LorasSummary}"/>
	                        </StackPanel>
	                    </Grid>

	                    <!-- Details grid: expands the same info bar (no stacked secondary bar) -->
	                    <Grid Grid.Row="1" Margin="0,8,0,0"
	                          Visibility="{Binding OverlayDetailsExpanded, Converter={StaticResource BoolToVis}}">
	                        <Grid.ColumnDefinitions>
	                            <ColumnDefinition Width="2*"/>
	                            <ColumnDefinition Width="*"/>
	                            <ColumnDefinition Width="*"/>
	                        </Grid.ColumnDefinitions>

	                        <StackPanel Grid.Column="0">
	                            <TextBlock Foreground="#FFF" Opacity="0.8" FontSize="12" Text="Prompt"/>
	                            <TextBlock Foreground="#FFF" FontSize="13" TextWrapping="Wrap"
	                                       Text="{Binding OverlaySelectedItem.Prompt}"/>
	                        </StackPanel>

	                        <StackPanel Grid.Column="1" Margin="12,0,0,0">
	                            <TextBlock Foreground="#FFF" Opacity="0.8" FontSize="12" Text="Settings"/>
	                            <TextBlock Foreground="#FFF" FontSize="12" TextWrapping="Wrap" Text="{Binding OverlaySelectedItem.Model, StringFormat=Model: {0}}"/>
	                            <TextBlock Foreground="#FFF" FontSize="12" Text="{Binding OverlaySelectedItem.Steps, StringFormat=Steps: {0}}"/>
	                            <TextBlock Foreground="#FFF" FontSize="12" Text="{Binding OverlaySelectedItem.CfgScale, StringFormat=CFG: {0}}"/>
	                        </StackPanel>

	                        <StackPanel Grid.Column="2" Margin="12,0,0,0">
	                            <TextBlock Foreground="#FFF" Opacity="0.8" FontSize="12" Text="Extras"/>
	                            <TextBlock Foreground="#FFF" FontSize="12" Text="{Binding OverlaySelectedItem.Seed, StringFormat=Seed: {0}}"/>
	                            <TextBlock Foreground="#FFF" FontSize="12" TextWrapping="Wrap" Text="{Binding OverlaySelectedItem.LorasSummary, StringFormat=LoRAs: {0}}"/>
	                        </StackPanel>
	                    </Grid>
	                </Grid>
            </Border>
        </Grid>

    </Grid>
</Window>





