<!-- CHANGE LOG
- 2026-03-12 | Request: Tag pills | Apply pill template to all tag displays including file cards.
- 2026-03-12 | Request: File name styling | Center and title-case file names in file cards.
- 2026-03-12 | Request: File cards | Add color strip, top tags, and path layout for file results.
-->
<!-- Bugfix: Fix duplicate IconBtn resource key by renaming base style to IconBtnBase so style lookups are unambiguous. -->
<!-- Bugfix: Allow the shared IconBtn style to apply to ToggleButton instances to prevent XamlParseException popups triggered by a Button-only style target. -->
<Window x:Class="PromptLoom.MainWindow"
        PreviewKeyDown="MainWindow_OnPreviewKeyDown"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:conv="clr-namespace:PromptLoom.Converters"
        xmlns:controls="clr-namespace:PromptLoom.Controls"
        xmlns:viewModels="clr-namespace:PromptLoom.ViewModels;assembly=PromptLoom.ViewModel"
        Title="PromptLoom 2.2.0" Height="900" Width="1480"
        Background="{StaticResource BgMain}"
        WindowStartupLocation="CenterScreen">

    <Window.Resources>
        <BooleanToVisibilityConverter x:Key="BoolToVis"/>
        <conv:PastelByIndexConverter x:Key="PastelByIndex"/>
        <conv:AspectToVisibilityConverter x:Key="AspectToVis"/>
        <conv:OneLineTextConverter x:Key="OneLine"/>
        <conv:CountToColumnsConverter x:Key="CountToColumns"/>
        <conv:TitleCaseConverter x:Key="TitleCase"/>
        <conv:LibraryPathConverter x:Key="LibraryPathConverter"/>

        <DataTemplate x:Key="TagPillTemplate">
            <Border Background="{StaticResource InputCyan}" CornerRadius="8" Padding="6,4" Margin="0,0,6,4">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="4"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>
                    <Border Grid.Row="0" Background="{Binding ColorHex}">
                        <Border.Style>
                            <Style TargetType="Border">
                                <Setter Property="Visibility" Value="Visible"/>
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding ColorHex}" Value="">
                                        <Setter Property="Visibility" Value="Collapsed"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </Border.Style>
                    </Border>
                    <TextBlock Grid.Row="1" FontSize="11" Text="{Binding Text}" TextAlignment="Center" Margin="0,4,0,0"/>
                </Grid>
            </Border>
        </DataTemplate>

        <DataTemplate x:Key="SwarmAssetCardTemplate">
            <Border Background="#14000000" BorderBrush="{StaticResource BorderSoft}" BorderThickness="1"
                    CornerRadius="8" Padding="6" Margin="0,2" ToolTip="{Binding Name}">
                <StackPanel>
                    <TextBlock FontWeight="SemiBold" Text="{Binding DisplayName}" TextTrimming="CharacterEllipsis"/>
                    <TextBlock FontSize="11" Opacity="0.65" Text="{Binding PathHint}" TextTrimming="CharacterEllipsis"
                               Visibility="{Binding HasPathHint, Converter={StaticResource BoolToVis}}"/>
                    <TextBlock FontSize="11" Opacity="0.7" Text="{Binding KindLabel}"/>
                </StackPanel>
            </Border>
        </DataTemplate>

        
        <!-- Vector icons (24x24) -->
        <Geometry x:Key="IcoChevronUp">M 12,6 L 6.5,11.5 L 8.0,13.0 L 12,9.0 L 16.0,13.0 L 17.5,11.5 Z</Geometry>
        <Geometry x:Key="IcoChevronDown">M 12,18 L 17.5,12.5 L 16.0,11.0 L 12,15.0 L 8.0,11.0 L 6.5,12.5 Z</Geometry>
        <!-- Legacy ordering icons retained for layout compatibility -->
        <Geometry x:Key="IcoChevronLeft">M 9.5,12 L 14.5,7 L 16.0,8.5 L 12.5,12 L 16.0,15.5 L 14.5,17 Z</Geometry>
        <Geometry x:Key="IcoChevronRight">M 14.5,12 L 9.5,7 L 8.0,8.5 L 11.5,12 L 8.0,15.5 L 9.5,17 Z</Geometry>
        <Geometry x:Key="IcoSelectAll">M 6,7 H 18 V 9 H 6 Z M 6,11 H 18 V 13 H 6 Z M 6,15 H 18 V 17 H 6 Z M 4.5,12 L 3.2,10.7 L 2,11.9 L 4.5,14.4 L 8.7,10.2 L 7.5,9 Z</Geometry>
        <Geometry x:Key="IcoSelectNone">M 12,2.5 A 9.5,9.5 0 1 1 11.999,2.5 Z M 7,11 H 17 V 13 H 7 Z</Geometry>
        <Geometry x:Key="IcoRefresh">M17.65,6.35A7.95,7.95 0 0,0 12,4V1L7,6l5,5V7c2.76,0 5,2.24 5,5 0,1.1 -0.36,2.12 -0.97,2.94l1.46,1.46A7.96,7.96 0 0,0 20,12c0-2.21-0.9-4.21-2.35-5.65z M6.35,17.65A7.95,7.95 0 0,0 12,20v3l5-5-5-5v3c-2.76,0-5-2.24-5-5 0-1.1 0.36-2.12 0.97-2.94L6.5,6.61A7.96,7.96 0 0,0 4,12c0,2.21 0.9,4.21 2.35,5.65z</Geometry>

        <!-- Round icon button style -->
        <Style x:Key="IconBtnBase" TargetType="ButtonBase">
            <Setter Property="Width" Value="26"/>
            <Setter Property="Height" Value="26"/>
            <Setter Property="Padding" Value="0"/>
            <Setter Property="Background" Value="#14FFFFFF"/>
            <Setter Property="BorderBrush" Value="#2A000000"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="ToolTipService.ShowDuration" Value="60000"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ButtonBase">
                        <Border x:Name="Bd"
                                Background="{TemplateBinding Background}"
                                BorderBrush="{TemplateBinding BorderBrush}"
                                BorderThickness="{TemplateBinding BorderThickness}"
                                CornerRadius="999"
                                SnapsToDevicePixels="True">
                            <ContentPresenter HorizontalAlignment="Center"
                                              VerticalAlignment="Center"
                                              RecognizesAccessKey="True"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="Bd" Property="Background" Value="#26FFFFFF"/>
                                <Setter TargetName="Bd" Property="BorderBrush" Value="#55000000"/>
                            </Trigger>
                            <Trigger Property="IsPressed" Value="True">
                                <Setter TargetName="Bd" Property="Background" Value="#36FFFFFF"/>
                                <Setter TargetName="Bd" Property="BorderBrush" Value="#77000000"/>
                                <Setter Property="RenderTransform">
                                    <Setter.Value>
                                        <ScaleTransform ScaleX="0.97" ScaleY="0.97"/>
                                    </Setter.Value>
                                </Setter>
                                <Setter Property="RenderTransformOrigin" Value="0.5,0.5"/>
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter TargetName="Bd" Property="Opacity" Value="0.45"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="IconBtn" TargetType="Button" BasedOn="{StaticResource IconBtnBase}"/>
        <Style x:Key="IconToggleBtn" TargetType="ToggleButton" BasedOn="{StaticResource IconBtnBase}"/>

        <!-- Consistent icon container -->
        <Style x:Key="IconPath" TargetType="Path">
            <Setter Property="Width" Value="14"/>
            <Setter Property="Height" Value="14"/>
            <Setter Property="Stretch" Value="Uniform"/>
            <Setter Property="Fill" Value="#222"/>
            <Setter Property="SnapsToDevicePixels" Value="True"/>
        </Style>
</Window.Resources>

    <Grid>
        <DockPanel>

        <Menu DockPanel.Dock="Top" Background="{StaticResource PanelBg}">
            <MenuItem Header="File">
                <MenuItem Header="Open Library Folder" Command="{Binding OpenFolderCommand}" />
                <MenuItem Header="Save Prompt to Output" Command="{Binding SaveOutputCommand}" />
                <Separator/>
                <MenuItem Header="Exit" Click="Exit_Click"/>
            </MenuItem>
        </Menu>

        <Border DockPanel.Dock="Bottom"
                CornerRadius="8"
                BorderBrush="{StaticResource BorderSoft}"
                BorderThickness="1"
                Background="{StaticResource PanelBg}"
                Padding="8"
                Margin="16,0,16,16">
            <DockPanel>
                <TextBlock DockPanel.Dock="Top" FontWeight="SemiBold" Text="Status" Margin="0,0,0,4"/>
                <StackPanel DockPanel.Dock="Right" Orientation="Horizontal" VerticalAlignment="Top" Margin="8,0,0,0">
                    <TextBlock Text="Refresh index" Opacity="0.7" VerticalAlignment="Center" Margin="0,0,6,0"/>
                    <Button Style="{StaticResource IconBtn}"
                            VerticalAlignment="Center"
                            ToolTip="Refresh tags"
                            Command="{Binding SearchViewModel.RefreshCommand}">
                        <Path Style="{StaticResource IconPath}" Data="{StaticResource IcoRefresh}"/>
                    </Button>
                </StackPanel>
                <StackPanel>
                    <TextBlock TextWrapping="Wrap" Margin="0,0,0,4">
                        <Run Text="Index Status: "/>
                        <Run Text="{Binding IndexStatusSummary, Mode=OneWay}"/>
                    </TextBlock>
                    <TextBlock TextWrapping="Wrap" Margin="0,0,0,4">
                        <Run Text="Generation: "/>
                        <Run Text="{Binding SwarmGenerationStatus, Mode=OneWay}"/>
                    </TextBlock>
                    <TextBlock TextWrapping="Wrap">
                        <Run Text="Errors: "/>
                        <Run Text="{Binding ErrorStatusSummary, Mode=OneWay}"/>
                    </TextBlock>
                </StackPanel>
            </DockPanel>
        </Border>

        <Grid Margin="16">

	            <!-- Landscape (default, side-by-side) -->
	            <Grid>
	                <Grid.Visibility>
	                    <MultiBinding Converter="{StaticResource AspectToVis}" ConverterParameter="invert">
	                        <Binding RelativeSource="{RelativeSource AncestorType=Window}" Path="ActualWidth"/>
	                        <Binding RelativeSource="{RelativeSource AncestorType=Window}" Path="ActualHeight"/>
	                    </MultiBinding>
	                </Grid.Visibility>

	                <Grid.ColumnDefinitions>
	                    <ColumnDefinition Width="*" MinWidth="520"/>
	                    <ColumnDefinition Width="10"/>
	                    <ColumnDefinition Width="*" MinWidth="420"/>
	                </Grid.ColumnDefinitions>

	                <GridSplitter Grid.Column="1" Width="10" HorizontalAlignment="Stretch" VerticalAlignment="Stretch" Background="Transparent"/>

            <DockPanel Grid.Column="0">


                <StackPanel DockPanel.Dock="Top" Margin="0,0,0,10">


                    <TextBlock FontSize="26" FontWeight="SemiBold" Text="Build" Foreground="{StaticResource AccentCyan}"/>


                </StackPanel>



            <Border Background="{StaticResource PanelBg}"
                    BorderBrush="{StaticResource BorderSoft}"
                    BorderThickness="1"
                    CornerRadius="14"
                    Padding="12"
                    DataContext="{Binding SearchViewModel}">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                            <StackPanel Grid.Row="0" Margin="0,0,0,10">
                                <DockPanel LastChildFill="True">
                                    <TextBox Text="{Binding SearchQuery, UpdateSourceTrigger=PropertyChanged}"
                                             Background="{StaticResource InputCyan}"
                                             MinWidth="220"
                                             Margin="0,0,8,0"/>
                                    <Button Content="Add Tag" Margin="0,0,8,0" Command="{Binding AddTagCommand}"/>
                                </DockPanel>
                                <TextBlock Text="Search tags" Opacity="0.7" Margin="0,8,0,6"/>
                                <Border Background="{StaticResource PanelBg}"
                                        BorderBrush="{StaticResource BorderSoft}"
                                        BorderThickness="1"
                                        CornerRadius="10"
                                        Padding="8"
                                        Margin="0,0,0,0">
                                    <Grid>
                                        <ItemsControl ItemsSource="{Binding SuggestedTags}">
                                            <ItemsControl.ItemsPanel>
                                                <ItemsPanelTemplate>
                                                    <WrapPanel/>
                                                </ItemsPanelTemplate>
                                            </ItemsControl.ItemsPanel>
                                            <ItemsControl.ItemTemplate>
                                                <DataTemplate>
                                                    <Button Padding="0"
                                                            Background="Transparent"
                                                            BorderThickness="0"
                                                            Content="{Binding}"
                                                            ContentTemplate="{StaticResource TagPillTemplate}"
                                                            Command="{Binding DataContext.AddTagCommand, RelativeSource={RelativeSource AncestorType=ItemsControl}}"
                                                            CommandParameter="{Binding Name}"/>
                                                </DataTemplate>
                                            </ItemsControl.ItemTemplate>
                                        </ItemsControl>
                                        <TextBlock Text="Search tags will appear here." Opacity="0.6">
                                            <TextBlock.Style>
                                                <Style TargetType="TextBlock">
                                                    <Setter Property="Visibility" Value="Collapsed"/>
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding SuggestedTags.Count}" Value="0">
                                                            <Setter Property="Visibility" Value="Visible"/>
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </TextBlock.Style>
                                        </TextBlock>
                                    </Grid>
                                </Border>
                            </StackPanel>

                            <StackPanel Grid.Row="1" Margin="0,0,0,10">
                                <TextBlock Text="Related tags" Opacity="0.7" Margin="0,0,0,6"/>
                                <Border Background="{StaticResource PanelBg}"
                                        BorderBrush="{StaticResource BorderSoft}"
                                        BorderThickness="1"
                                        CornerRadius="10"
                                        Padding="8">
                                    <Grid>
                                        <ItemsControl ItemsSource="{Binding RelatedTags}">
                                            <ItemsControl.ItemsPanel>
                                                <ItemsPanelTemplate>
                                                    <WrapPanel/>
                                                </ItemsPanelTemplate>
                                            </ItemsControl.ItemsPanel>
                                            <ItemsControl.ItemTemplate>
                                                <DataTemplate>
                                                    <Button Padding="0"
                                                            Background="Transparent"
                                                            BorderThickness="0"
                                                            Content="{Binding}"
                                                            ContentTemplate="{StaticResource TagPillTemplate}"
                                                            Command="{Binding DataContext.AddTagCommand, RelativeSource={RelativeSource AncestorType=ItemsControl}}"
                                                            CommandParameter="{Binding Name}"/>
                                                </DataTemplate>
                                            </ItemsControl.ItemTemplate>
                                        </ItemsControl>
                                        <TextBlock Text="Related tags will appear here." Opacity="0.6">
                                            <TextBlock.Style>
                                                <Style TargetType="TextBlock">
                                                    <Setter Property="Visibility" Value="Collapsed"/>
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding RelatedTags.Count}" Value="0">
                                                            <Setter Property="Visibility" Value="Visible"/>
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </TextBlock.Style>
                                        </TextBlock>
                                    </Grid>
                                </Border>
                            </StackPanel>

                            <StackPanel Grid.Row="2" Margin="0,0,0,10">
                                <TextBlock Text="Selected tags" Opacity="0.7" Margin="0,0,0,6"/>
                                <Border Background="{StaticResource PanelBg}"
                                        BorderBrush="{StaticResource BorderSoft}"
                                        BorderThickness="1"
                                        CornerRadius="10"
                                        Padding="8">
                                    <Grid>
                                        <ItemsControl ItemsSource="{Binding SelectedTags}">
                                            <ItemsControl.ItemsPanel>
                                                <ItemsPanelTemplate>
                                                    <WrapPanel/>
                                                </ItemsPanelTemplate>
                                            </ItemsControl.ItemsPanel>
                                            <ItemsControl.ItemTemplate>
                                                <DataTemplate>
                                                    <StackPanel Orientation="Horizontal" Margin="0,0,6,6">
                                                        <ContentPresenter Content="{Binding}" ContentTemplate="{StaticResource TagPillTemplate}"/>
                                                        <Button Content="x"
                                                                Padding="0"
                                                                Width="18"
                                                                Height="18"
                                                                Margin="0,4,0,0"
                                                                Command="{Binding DataContext.RemoveTagCommand, RelativeSource={RelativeSource AncestorType=ItemsControl}}"
                                                                CommandParameter="{Binding Name}"/>
                                                    </StackPanel>
                                                </DataTemplate>
                                            </ItemsControl.ItemTemplate>
                                        </ItemsControl>
                                        <TextBlock Text="Selected tags will appear here." Opacity="0.6">
                                            <TextBlock.Style>
                                                <Style TargetType="TextBlock">
                                                    <Setter Property="Visibility" Value="Collapsed"/>
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding SelectedTags.Count}" Value="0">
                                                            <Setter Property="Visibility" Value="Visible"/>
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </TextBlock.Style>
                                        </TextBlock>
                                    </Grid>
                                </Border>
                            </StackPanel>

                            <Grid Grid.Row="3">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="16"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>

                                <Border Grid.Column="0"
                                        Background="{StaticResource PanelBg}"
                                        BorderBrush="{StaticResource BorderSoft}"
                                        BorderThickness="1"
                                        CornerRadius="10"
                                        Padding="8">
                                    <Grid>
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="Auto"/>
                                            <RowDefinition Height="*"/>
                                        </Grid.RowDefinitions>
                                        <TextBlock Grid.Row="0" Text="Found files" Opacity="0.7" Margin="0,0,0,6"/>
                                        <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto">
                                            <ItemsControl ItemsSource="{Binding Results}">
                                                <ItemsControl.ItemsPanel>
                                                    <ItemsPanelTemplate>
                                                        <WrapPanel/>
                                                    </ItemsPanelTemplate>
                                                </ItemsControl.ItemsPanel>
                                                <ItemsControl.ItemTemplate>
                                                    <DataTemplate>
                                                        <Button Padding="10,6"
                                                                Margin="0,0,6,6"
                                                                Background="{StaticResource InputCyan}"
                                                                ToolTip="{Binding Path}"
                                                                Command="{Binding DataContext.SelectFileCommand, RelativeSource={RelativeSource AncestorType=ItemsControl}}"
                                                                CommandParameter="{Binding}">
                                                            <Button.Content>
                                                                <Grid Width="240">
                                                                    <Grid.RowDefinitions>
                                                                        <RowDefinition Height="6"/>
                                                                        <RowDefinition Height="Auto"/>
                                                                        <RowDefinition Height="Auto"/>
                                                                        <RowDefinition Height="Auto"/>
                                                                    </Grid.RowDefinitions>
                                                                    <ItemsControl Grid.Row="0" ItemsSource="{Binding PathColors}" Height="6" HorizontalAlignment="Stretch">
                                                                        <ItemsControl.ItemsPanel>
                                                                            <ItemsPanelTemplate>
                                                                                <UniformGrid Rows="1"
                                                                                             Columns="{Binding Items.Count, RelativeSource={RelativeSource AncestorType=ItemsControl}, Converter={StaticResource CountToColumns}}"/>
                                                                            </ItemsPanelTemplate>
                                                                        </ItemsControl.ItemsPanel>
                                                                        <ItemsControl.ItemTemplate>
                                                                            <DataTemplate>
                                                                                <Border Background="{Binding}"/>
                                                                            </DataTemplate>
                                                                        </ItemsControl.ItemTemplate>
                                                                    </ItemsControl>
                                                                    <TextBlock Grid.Row="1" FontWeight="SemiBold" FontSize="17" Margin="0,6,0,0"
                                                                               Text="{Binding FileName, Converter={StaticResource TitleCase}}"
                                                                               TextAlignment="Center"/>
                                                                    <ItemsControl Grid.Row="2"
                                                                                  ItemsSource="{Binding TagPills}"
                                                                                  ItemTemplate="{StaticResource TagPillTemplate}"
                                                                                  Margin="0,4,0,0"
                                                                                  HorizontalAlignment="Center">
                                                                        <ItemsControl.ItemsPanel>
                                                                            <ItemsPanelTemplate>
                                                                                <WrapPanel HorizontalAlignment="Center"/>
                                                                            </ItemsPanelTemplate>
                                                                        </ItemsControl.ItemsPanel>
                                                                    </ItemsControl>
                                                                    <TextBlock Grid.Row="3" Opacity="0.7" TextWrapping="Wrap" Text="{Binding RelativeFolderPath}"/>
                                                                </Grid>
                                                            </Button.Content>
                                                        </Button>
                                                    </DataTemplate>
                                                </ItemsControl.ItemTemplate>
                                            </ItemsControl>
                                        </ScrollViewer>
                                    </Grid>
                                </Border>

                                <Border Grid.Column="2"
                                        Background="{StaticResource PanelBg}"
                                        BorderBrush="{StaticResource BorderSoft}"
                                        BorderThickness="1"
                                        CornerRadius="10"
                                        Padding="8">
                                    <Grid>
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="Auto"/>
                                            <RowDefinition Height="*"/>
                                        </Grid.RowDefinitions>
                                        <DockPanel Grid.Row="0" Margin="0,0,0,6">
                                            <TextBlock Text="Selected files" Opacity="0.7" DockPanel.Dock="Left"/>
                                            <Button Content="Clear"
                                                    Padding="6,2"
                                                    Margin="8,0,0,0"
                                                    Command="{Binding ClearSelectedFilesCommand}"
                                                    HorizontalAlignment="Right"/>
                                        </DockPanel>
                                        <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto">
                                            <ItemsControl ItemsSource="{Binding SelectedFiles}">
                                                <ItemsControl.ItemsPanel>
                                                    <ItemsPanelTemplate>
                                                        <StackPanel/>
                                                    </ItemsPanelTemplate>
                                                </ItemsControl.ItemsPanel>
                                                <ItemsControl.ItemTemplate>
                                                    <DataTemplate>
                                                        <Grid Margin="0,0,0,6">
                                                            <Grid.ColumnDefinitions>
                                                                <ColumnDefinition Width="*"/>
                                                                <ColumnDefinition Width="Auto"/>
                                                            </Grid.ColumnDefinitions>
                                                            <Button Grid.Column="0"
                                                                    Padding="10,6"
                                                                    Margin="0,0,8,0"
                                                                    Background="{StaticResource InputCyan}"
                                                                    ToolTip="{Binding Path}"
                                                                    Command="{Binding DataContext.RemoveSelectedFileCommand, RelativeSource={RelativeSource AncestorType=ItemsControl}}"
                                                                    CommandParameter="{Binding}">
                                                                <Button.Content>
                                                                    <Grid Width="240">
                                                                        <Grid.RowDefinitions>
                                                                            <RowDefinition Height="6"/>
                                                                            <RowDefinition Height="Auto"/>
                                                                            <RowDefinition Height="Auto"/>
                                                                            <RowDefinition Height="Auto"/>
                                                                        </Grid.RowDefinitions>
                                                                        <ItemsControl Grid.Row="0" ItemsSource="{Binding PathColors}" Height="6" HorizontalAlignment="Stretch">
                                                                            <ItemsControl.ItemsPanel>
                                                                                <ItemsPanelTemplate>
                                                                                    <UniformGrid Rows="1"
                                                                                                 Columns="{Binding Items.Count, RelativeSource={RelativeSource AncestorType=ItemsControl}, Converter={StaticResource CountToColumns}}"/>
                                                                                </ItemsPanelTemplate>
                                                                            </ItemsControl.ItemsPanel>
                                                                            <ItemsControl.ItemTemplate>
                                                                                <DataTemplate>
                                                                                    <Border Background="{Binding}"/>
                                                                                </DataTemplate>
                                                                            </ItemsControl.ItemTemplate>
                                                                        </ItemsControl>
                                                                        <TextBlock Grid.Row="1" FontWeight="SemiBold" FontSize="17" Margin="0,6,0,0"
                                                                                   Text="{Binding FileName, Converter={StaticResource TitleCase}}"
                                                                                   TextAlignment="Center"/>
                                                                        <ItemsControl Grid.Row="2"
                                                                                      ItemsSource="{Binding TagPills}"
                                                                                      ItemTemplate="{StaticResource TagPillTemplate}"
                                                                                      Margin="0,4,0,0"
                                                                                      HorizontalAlignment="Center">
                                                                            <ItemsControl.ItemsPanel>
                                                                                <ItemsPanelTemplate>
                                                                                    <WrapPanel HorizontalAlignment="Center"/>
                                                                                </ItemsPanelTemplate>
                                                                            </ItemsControl.ItemsPanel>
                                                                        </ItemsControl>
                                                                        <TextBlock Grid.Row="3" Opacity="0.7" TextWrapping="Wrap" Text="{Binding RelativeFolderPath}"/>
                                                                    </Grid>
                                                                </Button.Content>
                                                            </Button>
                                                            <StackPanel Grid.Column="1" VerticalAlignment="Center">
                                                                <Button Content="^"
                                                                        Width="24"
                                                                        Height="24"
                                                                        Margin="0,0,0,4"
                                                                        Command="{Binding DataContext.MoveSelectedFileUpCommand, RelativeSource={RelativeSource AncestorType=ItemsControl}}"
                                                                        CommandParameter="{Binding}"/>
                                                                <Button Content="x"
                                                                        Width="24"
                                                                        Height="24"
                                                                        Margin="0,0,0,4"
                                                                        Command="{Binding DataContext.RemoveSelectedFileCommand, RelativeSource={RelativeSource AncestorType=ItemsControl}}"
                                                                        CommandParameter="{Binding}"/>
                                                                <Button Content="v"
                                                                        Width="24"
                                                                        Height="24"
                                                                        Command="{Binding DataContext.MoveSelectedFileDownCommand, RelativeSource={RelativeSource AncestorType=ItemsControl}}"
                                                                        CommandParameter="{Binding}"/>
                                                            </StackPanel>
                                                        </Grid>
                                                    </DataTemplate>
                                                </ItemsControl.ItemTemplate>
                                            </ItemsControl>
                                        </ScrollViewer>
                                    </Grid>
                                </Border>
                            </Grid>

                            <StackPanel Grid.Row="4" Margin="0,10,0,0">
                                <TextBlock Text="Current prompt" Opacity="0.7" Margin="0,0,0,6"/>
                                <Border Background="{StaticResource PanelBg}"
                                        BorderBrush="{StaticResource BorderSoft}"
                                        BorderThickness="1"
                                        CornerRadius="10"
                                        Padding="8">
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="12"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>
                                        <TextBlock Grid.Column="0"
                                                   Text="{Binding DataContext.PromptText, RelativeSource={RelativeSource AncestorType=Window}}"
                                                   TextWrapping="Wrap"
                                                   Opacity="0.85"/>
                                        <StackPanel Grid.Column="2" VerticalAlignment="Top">
                                            <StackPanel Orientation="Horizontal" Margin="0,0,0,6">
                                                <TextBlock Text="Batch qty" Opacity="0.7"/>
                                                <TextBlock Text="{Binding DataContext.BatchQty, RelativeSource={RelativeSource AncestorType=Window}}"
                                                           Opacity="0.7"
                                                           Margin="6,0,0,0"/>
                                            </StackPanel>
                                            <Slider Width="140"
                                                    Minimum="0"
                                                    Maximum="20"
                                                    TickFrequency="1"
                                                    IsSnapToTickEnabled="True"
                                                    Value="{Binding DataContext.BatchQty, RelativeSource={RelativeSource AncestorType=Window}, UpdateSourceTrigger=PropertyChanged}"/>
                                            <Button Content="Batch Send"
                                                    Height="28"
                                                    Margin="0,6,0,0"
                                                    Command="{Binding DataContext.SendBatchToSwarmUiCommand, RelativeSource={RelativeSource AncestorType=Window}}"/>
                                        </StackPanel>
                                    </Grid>
                                </Border>
                            </StackPanel>


                        </Grid>
                    </Border>

            </DockPanel>

            <TabControl Grid.Column="2" Background="Transparent" BorderThickness="0">
                <TabItem Header="Prompt">
                    <controls:PromptPanel/>
                </TabItem>
                <TabItem Header="Settings">
                    <controls:SettingsPanel/>
                </TabItem>
            </TabControl>


	        </Grid>

	        <!-- Portrait (stacked) -->
	        <Grid>
	            <Grid.Visibility>
	                <MultiBinding Converter="{StaticResource AspectToVis}">
	                    <Binding RelativeSource="{RelativeSource AncestorType=Window}" Path="ActualWidth"/>
	                    <Binding RelativeSource="{RelativeSource AncestorType=Window}" Path="ActualHeight"/>
	                </MultiBinding>
	            </Grid.Visibility>

	            <TabControl Background="Transparent" BorderThickness="0">
	                <TabItem Header="Build">
	                    <Border Background="{StaticResource PanelBg}"
	                            BorderBrush="{StaticResource BorderSoft}"
	                            BorderThickness="1"
	                            CornerRadius="14"
	                            Padding="12"
	                            DataContext="{Binding SearchViewModel}">
	                        <Grid>
	                            <Grid.RowDefinitions>
	                                <RowDefinition Height="Auto"/>
	                                <RowDefinition Height="Auto"/>
	                                <RowDefinition Height="Auto"/>
	                                <RowDefinition Height="*"/>
	                                <RowDefinition Height="Auto"/>
	                                <RowDefinition Height="Auto"/>
	                            </Grid.RowDefinitions>

                            <StackPanel Grid.Row="0" Margin="0,0,0,10">
                                <DockPanel LastChildFill="True">
                                    <TextBox Text="{Binding SearchQuery, UpdateSourceTrigger=PropertyChanged}"
                                             Background="{StaticResource InputCyan}"
                                             MinWidth="220"
                                             Margin="0,0,8,0"/>
                                    <Button Content="Add Tag" Margin="0,0,8,0" Command="{Binding AddTagCommand}"/>
                                </DockPanel>
                                <TextBlock Text="Search tags" Opacity="0.7" Margin="0,8,0,6"/>
                                <Border Background="{StaticResource PanelBg}"
                                        BorderBrush="{StaticResource BorderSoft}"
                                        BorderThickness="1"
                                        CornerRadius="10"
                                        Padding="8"
                                        Margin="0,0,0,0">
                                    <Grid>
                                        <ItemsControl ItemsSource="{Binding SuggestedTags}">
                                            <ItemsControl.ItemsPanel>
                                                <ItemsPanelTemplate>
                                                    <WrapPanel/>
                                                </ItemsPanelTemplate>
                                            </ItemsControl.ItemsPanel>
                                            <ItemsControl.ItemTemplate>
                                                <DataTemplate>
                                                    <Button Padding="0"
                                                            Background="Transparent"
                                                            BorderThickness="0"
                                                            Content="{Binding}"
                                                            ContentTemplate="{StaticResource TagPillTemplate}"
                                                            Command="{Binding DataContext.AddTagCommand, RelativeSource={RelativeSource AncestorType=ItemsControl}}"
                                                            CommandParameter="{Binding Name}"/>
                                                </DataTemplate>
                                            </ItemsControl.ItemTemplate>
                                        </ItemsControl>
                                        <TextBlock Text="Search tags will appear here." Opacity="0.6">
                                            <TextBlock.Style>
                                                <Style TargetType="TextBlock">
                                                    <Setter Property="Visibility" Value="Collapsed"/>
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding SuggestedTags.Count}" Value="0">
                                                            <Setter Property="Visibility" Value="Visible"/>
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </TextBlock.Style>
                                        </TextBlock>
                                    </Grid>
                                </Border>
                            </StackPanel>

                            <StackPanel Grid.Row="1" Margin="0,0,0,10">
                                <TextBlock Text="Related tags" Opacity="0.7" Margin="0,0,0,6"/>
                                <Border Background="{StaticResource PanelBg}"
                                        BorderBrush="{StaticResource BorderSoft}"
                                        BorderThickness="1"
                                        CornerRadius="10"
                                        Padding="8">
                                    <Grid>
                                        <ItemsControl ItemsSource="{Binding RelatedTags}">
                                            <ItemsControl.ItemsPanel>
                                                <ItemsPanelTemplate>
                                                    <WrapPanel/>
                                                </ItemsPanelTemplate>
                                            </ItemsControl.ItemsPanel>
                                            <ItemsControl.ItemTemplate>
                                                <DataTemplate>
                                                    <Button Padding="0"
                                                            Background="Transparent"
                                                            BorderThickness="0"
                                                            Content="{Binding}"
                                                            ContentTemplate="{StaticResource TagPillTemplate}"
                                                            Command="{Binding DataContext.AddTagCommand, RelativeSource={RelativeSource AncestorType=ItemsControl}}"
                                                            CommandParameter="{Binding Name}"/>
                                                </DataTemplate>
                                            </ItemsControl.ItemTemplate>
                                        </ItemsControl>
                                        <TextBlock Text="Related tags will appear here." Opacity="0.6">
                                            <TextBlock.Style>
                                                <Style TargetType="TextBlock">
                                                    <Setter Property="Visibility" Value="Collapsed"/>
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding RelatedTags.Count}" Value="0">
                                                            <Setter Property="Visibility" Value="Visible"/>
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </TextBlock.Style>
                                        </TextBlock>
                                    </Grid>
                                </Border>
                            </StackPanel>

                            <StackPanel Grid.Row="2" Margin="0,0,0,10">
                                <TextBlock Text="Selected tags" Opacity="0.7" Margin="0,0,0,6"/>
                                <Border Background="{StaticResource PanelBg}"
                                        BorderBrush="{StaticResource BorderSoft}"
                                        BorderThickness="1"
                                        CornerRadius="10"
                                        Padding="8">
                                    <Grid>
                                        <ItemsControl ItemsSource="{Binding SelectedTags}">
                                            <ItemsControl.ItemsPanel>
                                                <ItemsPanelTemplate>
                                                    <WrapPanel/>
                                                </ItemsPanelTemplate>
                                            </ItemsControl.ItemsPanel>
                                            <ItemsControl.ItemTemplate>
                                                <DataTemplate>
                                                    <StackPanel Orientation="Horizontal" Margin="0,0,6,6">
                                                        <ContentPresenter Content="{Binding}" ContentTemplate="{StaticResource TagPillTemplate}"/>
                                                        <Button Content="x"
                                                                Padding="0"
                                                                Width="18"
                                                                Height="18"
                                                                Margin="0,4,0,0"
                                                                Command="{Binding DataContext.RemoveTagCommand, RelativeSource={RelativeSource AncestorType=ItemsControl}}"
                                                                CommandParameter="{Binding Name}"/>
                                                    </StackPanel>
                                                </DataTemplate>
                                            </ItemsControl.ItemTemplate>
                                        </ItemsControl>
                                        <TextBlock Text="Selected tags will appear here." Opacity="0.6">
                                            <TextBlock.Style>
                                                <Style TargetType="TextBlock">
                                                    <Setter Property="Visibility" Value="Collapsed"/>
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding SelectedTags.Count}" Value="0">
                                                            <Setter Property="Visibility" Value="Visible"/>
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </TextBlock.Style>
                                        </TextBlock>
                                    </Grid>
                                </Border>
                            </StackPanel>

                            <Grid Grid.Row="3">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="16"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>

                                <Border Grid.Column="0"
                                        Background="{StaticResource PanelBg}"
                                        BorderBrush="{StaticResource BorderSoft}"
                                        BorderThickness="1"
                                        CornerRadius="10"
                                        Padding="8">
                                    <Grid>
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="Auto"/>
                                            <RowDefinition Height="*"/>
                                        </Grid.RowDefinitions>
                                        <TextBlock Grid.Row="0" Text="Found files" Opacity="0.7" Margin="0,0,0,6"/>
                                        <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto">
                                            <ItemsControl ItemsSource="{Binding Results}">
                                                <ItemsControl.ItemsPanel>
                                                    <ItemsPanelTemplate>
                                                        <WrapPanel/>
                                                    </ItemsPanelTemplate>
                                                </ItemsControl.ItemsPanel>
                                                <ItemsControl.ItemTemplate>
                                                    <DataTemplate>
                                                        <Button Padding="10,6"
                                                                Margin="0,0,6,6"
                                                                Background="{StaticResource InputCyan}"
                                                                ToolTip="{Binding Path}"
                                                                Command="{Binding DataContext.SelectFileCommand, RelativeSource={RelativeSource AncestorType=ItemsControl}}"
                                                                CommandParameter="{Binding}">
                                                            <Button.Content>
                                                                <Grid Width="240">
                                                                    <Grid.RowDefinitions>
                                                                        <RowDefinition Height="6"/>
                                                                        <RowDefinition Height="Auto"/>
                                                                        <RowDefinition Height="Auto"/>
                                                                        <RowDefinition Height="Auto"/>
                                                                    </Grid.RowDefinitions>
                                                                    <ItemsControl Grid.Row="0" ItemsSource="{Binding PathColors}" Height="6" HorizontalAlignment="Stretch">
                                                                        <ItemsControl.ItemsPanel>
                                                                            <ItemsPanelTemplate>
                                                                                <UniformGrid Rows="1"
                                                                                             Columns="{Binding Items.Count, RelativeSource={RelativeSource AncestorType=ItemsControl}, Converter={StaticResource CountToColumns}}"/>
                                                                            </ItemsPanelTemplate>
                                                                        </ItemsControl.ItemsPanel>
                                                                        <ItemsControl.ItemTemplate>
                                                                            <DataTemplate>
                                                                                <Border Background="{Binding}"/>
                                                                            </DataTemplate>
                                                                        </ItemsControl.ItemTemplate>
                                                                    </ItemsControl>
                                                                    <TextBlock Grid.Row="1" FontWeight="SemiBold" FontSize="17" Margin="0,6,0,0"
                                                                               Text="{Binding FileName, Converter={StaticResource TitleCase}}"
                                                                               TextAlignment="Center"/>
                                                                    <ItemsControl Grid.Row="2"
                                                                                  ItemsSource="{Binding TagPills}"
                                                                                  ItemTemplate="{StaticResource TagPillTemplate}"
                                                                                  Margin="0,4,0,0"
                                                                                  HorizontalAlignment="Center">
                                                                        <ItemsControl.ItemsPanel>
                                                                            <ItemsPanelTemplate>
                                                                                <WrapPanel HorizontalAlignment="Center"/>
                                                                            </ItemsPanelTemplate>
                                                                        </ItemsControl.ItemsPanel>
                                                                    </ItemsControl>
                                                                    <TextBlock Grid.Row="3" Opacity="0.7" TextWrapping="Wrap" Text="{Binding RelativeFolderPath}"/>
                                                                </Grid>
                                                            </Button.Content>
                                                        </Button>
                                                    </DataTemplate>
                                                </ItemsControl.ItemTemplate>
                                            </ItemsControl>
                                        </ScrollViewer>
                                    </Grid>
                                </Border>

                                <Border Grid.Column="2"
                                        Background="{StaticResource PanelBg}"
                                        BorderBrush="{StaticResource BorderSoft}"
                                        BorderThickness="1"
                                        CornerRadius="10"
                                        Padding="8">
                                    <Grid>
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="Auto"/>
                                            <RowDefinition Height="*"/>
                                        </Grid.RowDefinitions>
                                        <DockPanel Grid.Row="0" Margin="0,0,0,6">
                                            <TextBlock Text="Selected files" Opacity="0.7" DockPanel.Dock="Left"/>
                                            <Button Content="Clear"
                                                    Padding="6,2"
                                                    Margin="8,0,0,0"
                                                    Command="{Binding ClearSelectedFilesCommand}"
                                                    HorizontalAlignment="Right"/>
                                        </DockPanel>
                                        <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto">
                                            <ItemsControl ItemsSource="{Binding SelectedFiles}">
                                                <ItemsControl.ItemsPanel>
                                                    <ItemsPanelTemplate>
                                                        <StackPanel/>
                                                    </ItemsPanelTemplate>
                                                </ItemsControl.ItemsPanel>
                                                <ItemsControl.ItemTemplate>
                                                    <DataTemplate>
                                                        <StackPanel Orientation="Horizontal" Margin="0,0,0,6">
                                                            <Button Padding="10,6"
                                                                    Margin="0,0,8,0"
                                                                    Background="{StaticResource InputCyan}"
                                                                    ToolTip="{Binding Path}"
                                                                    Command="{Binding DataContext.RemoveSelectedFileCommand, RelativeSource={RelativeSource AncestorType=ItemsControl}}"
                                                                    CommandParameter="{Binding}">
                                                                <Button.Content>
                                                                    <Grid Width="240">
                                                                        <Grid.RowDefinitions>
                                                                            <RowDefinition Height="6"/>
                                                                            <RowDefinition Height="Auto"/>
                                                                            <RowDefinition Height="Auto"/>
                                                                            <RowDefinition Height="Auto"/>
                                                                        </Grid.RowDefinitions>
                                                                        <ItemsControl Grid.Row="0" ItemsSource="{Binding PathColors}" Height="6" HorizontalAlignment="Stretch">
                                                                            <ItemsControl.ItemsPanel>
                                                                                <ItemsPanelTemplate>
                                                                                    <UniformGrid Rows="1"
                                                                                                 Columns="{Binding Items.Count, RelativeSource={RelativeSource AncestorType=ItemsControl}, Converter={StaticResource CountToColumns}}"/>
                                                                                </ItemsPanelTemplate>
                                                                            </ItemsControl.ItemsPanel>
                                                                            <ItemsControl.ItemTemplate>
                                                                                <DataTemplate>
                                                                                    <Border Background="{Binding}"/>
                                                                                </DataTemplate>
                                                                            </ItemsControl.ItemTemplate>
                                                                        </ItemsControl>
                                                                        <TextBlock Grid.Row="1" FontWeight="SemiBold" FontSize="17" Margin="0,6,0,0"
                                                                                   Text="{Binding FileName, Converter={StaticResource TitleCase}}"
                                                                                   TextAlignment="Center"/>
                                                                        <ItemsControl Grid.Row="2"
                                                                                      ItemsSource="{Binding TagPills}"
                                                                                      ItemTemplate="{StaticResource TagPillTemplate}"
                                                                                      Margin="0,4,0,0"
                                                                                      HorizontalAlignment="Center">
                                                                            <ItemsControl.ItemsPanel>
                                                                                <ItemsPanelTemplate>
                                                                                    <WrapPanel HorizontalAlignment="Center"/>
                                                                                </ItemsPanelTemplate>
                                                                            </ItemsControl.ItemsPanel>
                                                                        </ItemsControl>
                                                                        <TextBlock Grid.Row="3" Opacity="0.7" TextWrapping="Wrap" Text="{Binding RelativeFolderPath}"/>
                                                                    </Grid>
                                                                </Button.Content>
                                                            </Button>
                                                            <Button Content="^"
                                                                    Width="24"
                                                                    Height="24"
                                                                    Margin="0,0,4,0"
                                                                    Command="{Binding DataContext.MoveSelectedFileUpCommand, RelativeSource={RelativeSource AncestorType=ItemsControl}}"
                                                                    CommandParameter="{Binding}"/>
                                                            <Button Content="v"
                                                                    Width="24"
                                                                    Height="24"
                                                                    Margin="0,0,4,0"
                                                                    Command="{Binding DataContext.MoveSelectedFileDownCommand, RelativeSource={RelativeSource AncestorType=ItemsControl}}"
                                                                    CommandParameter="{Binding}"/>
                                                            <Button Content="x"
                                                                    Width="24"
                                                                    Height="24"
                                                                    Command="{Binding DataContext.RemoveSelectedFileCommand, RelativeSource={RelativeSource AncestorType=ItemsControl}}"
                                                                    CommandParameter="{Binding}"/>
                                                        </StackPanel>
                                                    </DataTemplate>
                                                </ItemsControl.ItemTemplate>
                                            </ItemsControl>
                                        </ScrollViewer>
                                    </Grid>
                                </Border>
                            </Grid>

                            <StackPanel Grid.Row="4" Margin="0,10,0,0">
                                <TextBlock Text="Current prompt" Opacity="0.7" Margin="0,0,0,6"/>
                                <Border Background="{StaticResource PanelBg}"
                                        BorderBrush="{StaticResource BorderSoft}"
                                        BorderThickness="1"
                                        CornerRadius="10"
                                        Padding="8">
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="12"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>
                                        <TextBlock Grid.Column="0"
                                                   Text="{Binding DataContext.PromptText, RelativeSource={RelativeSource AncestorType=Window}}"
                                                   TextWrapping="Wrap"
                                                   Opacity="0.85"/>
                                        <StackPanel Grid.Column="2" VerticalAlignment="Top">
                                            <StackPanel Orientation="Horizontal" Margin="0,0,0,6">
                                                <TextBlock Text="Batch qty" Opacity="0.7"/>
                                                <TextBlock Text="{Binding DataContext.BatchQty, RelativeSource={RelativeSource AncestorType=Window}}"
                                                           Opacity="0.7"
                                                           Margin="6,0,0,0"/>
                                            </StackPanel>
                                            <Slider Width="140"
                                                    Minimum="0"
                                                    Maximum="20"
                                                    TickFrequency="1"
                                                    IsSnapToTickEnabled="True"
                                                    Value="{Binding DataContext.BatchQty, RelativeSource={RelativeSource AncestorType=Window}, UpdateSourceTrigger=PropertyChanged}"/>
                                            <Button Content="Batch Send"
                                                    Height="28"
                                                    Margin="0,6,0,0"
                                                    Command="{Binding DataContext.SendBatchToSwarmUiCommand, RelativeSource={RelativeSource AncestorType=Window}}"/>
                                        </StackPanel>
                                    </Grid>
                                </Border>
                            </StackPanel>


	                        </Grid>
	                    </Border>
	                </TabItem>
	                <TabItem Header="Prompt">
	                    <controls:PromptPanel/>
	                </TabItem>
	                <TabItem Header="Settings">
	                    <controls:SettingsPanel/>
	                </TabItem>
	            </TabControl>
	        </Grid>

	        </Grid>
	</DockPanel>

        <!-- Fullscreen image overlay: close via  only; image supports zoom (wheel/up/down) + pan (drag) + prev/next (edges/left-right) -->
	        <Grid x:Name="ImageOverlayRoot" Panel.ZIndex="999"
              Background="#88000000"
	              Visibility="{Binding IsImageOverlayVisible, Converter={StaticResource BoolToVis}}"
	              MouseDown="ImageOverlayRoot_MouseDown">
            <Grid.RowDefinitions>
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <!-- Image layer -->
            <Grid Grid.Row="0" Panel.ZIndex="5">
	                <controls:ZoomPanImage x:Name="OverlayZoomPan"
	                                      Source="{Binding OverlayImage}"
	                                      ClickLeftCommand="{Binding OverlayPrevCommand}"
	                                      ClickRightCommand="{Binding OverlayNextCommand}"
	                                      CloseCommand="{Binding HideImageOverlayCommand}"/>

                <Button HorizontalAlignment="Right" VerticalAlignment="Top" Margin="12" Width="40" Height="40"
                        Background="#AA000000" Foreground="#FFF" BorderBrush="#33FFFFFF" BorderThickness="1"
                        Content="" FontSize="16" FontWeight="SemiBold"
                        Command="{Binding HideImageOverlayCommand}"/>
            </Grid>

            <!-- Bottom info bar: 3-panel header grid; expands upward to show full details -->
            <Border Grid.Row="1" Background="#CC0B0B0B" BorderBrush="#33FFFFFF" BorderThickness="1" Padding="10">
	                <Grid>
	                    <Grid.RowDefinitions>
	                        <RowDefinition Height="56"/>
	                        <RowDefinition Height="Auto"/>
	                    </Grid.RowDefinitions>

	                    <!-- Header grid (always visible) -->
	                    <Grid Grid.Row="0" ClipToBounds="True">
	                        <Grid.ColumnDefinitions>
	                            <ColumnDefinition Width="2*"/>
	                            <ColumnDefinition Width="*"/>
	                            <ColumnDefinition Width="*"/>
	                        </Grid.ColumnDefinitions>

	                        <!-- Panel 1: prompt (wrap to two lines) -->
                                <Button Grid.Column="0" Background="Transparent" BorderThickness="0" Padding="0"
                                        Command="{Binding ToggleOverlayDetailsCommand}">
                                    <!-- WPF TextBlock lacks MaxLines; cap at ~2 lines via line height/max height. -->
                                    <TextBlock Foreground="#FFF" FontSize="13" TextWrapping="Wrap"
                                               LineStackingStrategy="BlockLineHeight" LineHeight="16" MaxHeight="32"
                                               TextTrimming="CharacterEllipsis"
                                               Text="{Binding OverlaySelectedItem.PromptShort}"
                                               ToolTip="{Binding OverlaySelectedItem.Prompt}"/>
                                </Button>

	                        <!-- Panel 2: model / steps / cfg -->
	                        <StackPanel Grid.Column="1" Margin="12,0,0,0" VerticalAlignment="Center">
	                            <TextBlock Foreground="#FFF" Opacity="0.85" FontSize="12" TextWrapping="NoWrap" TextTrimming="CharacterEllipsis"
	                                       Text="{Binding OverlaySelectedItem.Model}"/>
	                            <TextBlock Foreground="#FFF" Opacity="0.65" FontSize="11"
	                                       Text="{Binding OverlaySelectedItem.Steps, StringFormat=Steps: {0}}"/>
	                            <TextBlock Foreground="#FFF" Opacity="0.65" FontSize="11"
	                                       Text="{Binding OverlaySelectedItem.CfgScale, StringFormat=CFG: {0}}"/>
	                        </StackPanel>

	                        <!-- Panel 3: seed / loras -->
	                        <StackPanel Grid.Column="2" Margin="12,0,0,0" VerticalAlignment="Center">
	                            <TextBlock Foreground="#FFF" Opacity="0.85" FontSize="12"
	                                       Text="{Binding OverlaySelectedItem.Seed, StringFormat=Seed: {0}}"/>
	                            <TextBlock Foreground="#FFF" Opacity="0.65" FontSize="11" TextWrapping="NoWrap" TextTrimming="CharacterEllipsis"
	                                       Text="{Binding OverlaySelectedItem.LorasSummary}"/>
	                        </StackPanel>
	                    </Grid>

	                    <!-- Details grid: expands the same info bar (no stacked secondary bar) -->
	                    <Grid Grid.Row="1" Margin="0,8,0,0"
	                          Visibility="{Binding OverlayDetailsExpanded, Converter={StaticResource BoolToVis}}">
	                        <Grid.ColumnDefinitions>
	                            <ColumnDefinition Width="2*"/>
	                            <ColumnDefinition Width="*"/>
	                            <ColumnDefinition Width="*"/>
	                        </Grid.ColumnDefinitions>

	                        <StackPanel Grid.Column="0">
	                            <TextBlock Foreground="#FFF" Opacity="0.8" FontSize="12" Text="Prompt"/>
	                            <TextBlock Foreground="#FFF" FontSize="13" TextWrapping="Wrap"
	                                       Text="{Binding OverlaySelectedItem.Prompt}"/>
	                        </StackPanel>

	                        <StackPanel Grid.Column="1" Margin="12,0,0,0">
	                            <TextBlock Foreground="#FFF" Opacity="0.8" FontSize="12" Text="Settings"/>
	                            <TextBlock Foreground="#FFF" FontSize="12" TextWrapping="Wrap" Text="{Binding OverlaySelectedItem.Model, StringFormat=Model: {0}}"/>
	                            <TextBlock Foreground="#FFF" FontSize="12" Text="{Binding OverlaySelectedItem.Steps, StringFormat=Steps: {0}}"/>
	                            <TextBlock Foreground="#FFF" FontSize="12" Text="{Binding OverlaySelectedItem.CfgScale, StringFormat=CFG: {0}}"/>
	                        </StackPanel>

	                        <StackPanel Grid.Column="2" Margin="12,0,0,0">
	                            <TextBlock Foreground="#FFF" Opacity="0.8" FontSize="12" Text="Extras"/>
	                            <TextBlock Foreground="#FFF" FontSize="12" Text="{Binding OverlaySelectedItem.Seed, StringFormat=Seed: {0}}"/>
	                            <TextBlock Foreground="#FFF" FontSize="12" TextWrapping="Wrap" Text="{Binding OverlaySelectedItem.LorasSummary, StringFormat=LoRAs: {0}}"/>
	                        </StackPanel>
	                    </Grid>
	                </Grid>
            </Border>
        </Grid>

    </Grid>
</Window>








